<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Election</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the app */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #e0f2f7, #c1e4ed); /* Light blue gradient */
            color: #374151; /* Dark gray text */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        /* Styles for the initial login screen (matching screenshot) */
        .initial-login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed; /* Fixed to cover entire screen */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom right, #e0f2f7, #c1e4ed); /* Match body background */
            z-index: 999; /* Ensure it's on top */
        }
        .initial-login-card {
            background-color: #ffffff;
            border-radius: 1.5rem; /* More rounded */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Softer shadow */
            padding: 2.5rem;
            max-width: 400px; /* Compact width */
            width: 90%; /* Responsive width */
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        /* Main App Container - Adjusted for a more centralized, compact look and responsiveness */
        .app-container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* Rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Soft shadow */
            padding: 2.5rem;
            max-width: 1200px; /* Increased max width for overall app */
            width: 100%;
            display: flex;
            flex-direction: column; /* Default to column on small screens */
            gap: 1.5rem; /* Spacing between main content and sidebar */
            min-height: 80vh; /* Ensure it takes up a good portion of the viewport */
        }

        /* Main content and sidebar are now stacked vertically on small screens, side-by-side on larger */
        .main-content-area, .sidebar-area {
            background-color: #f8fafc; /* Lighter background for content */
            border-radius: 1rem; /* Slightly less rounded than container */
            padding: 1.5rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            flex-grow: 1; /* Allows content to grow */
        }
        @media (min-width: 1024px) { /* On large screens (lg), arrange side-by-side */
            .app-container {
                flex-direction: row; /* Row direction for desktop */
            }
            .main-content-area {
                flex: 2; /* Main content takes 2 parts */
            }
            .sidebar-area {
                flex: 1; /* Sidebar takes 1 part */
            }
        }

        /* Tab button styles */
        .tab-button {
            background-color: #cbd5e0; /* Light gray for inactive tabs */
            color: #4a5568; /* Darker text */
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-grow: 1; /* Allow buttons to grow and fill space */
            text-align: center; /* Center text in buttons */
        }
        .tab-button:hover {
            background-color: #a0aec0; /* Darker gray on hover */
            color: white;
        }
        .tab-button.active {
            background: linear-gradient(to right, #3b82f6, #6366f1); /* Blue to indigo gradient */
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* Input field styles */
        .input-field {
            background-color: #f1f5f9; /* Off-white for inputs */
            border: 1px solid #cbd5e0;
            color: #374151;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }
        .input-field::placeholder {
            color: #94a3b8;
        }
        .input-field:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }
        .input-field option {
            background-color: #ffffff; /* White background for select options */
            color: #374151;
        }

        /* Action button styles */
        .action-button {
            background: linear-gradient(to right, #3b82f6, #6366f1); /* Blue to indigo gradient */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.2);
            background: linear-gradient(to right, #2563eb, #4f46e5);
        }

        /* Party card styles */
        .party-card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .party-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }
        .party-logo-small {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #a855f7; /* Purple border */
        }
        .party-logo-large {
            max-width: 120px;
            height: auto;
            border-radius: 1rem;
            margin-top: 10px;
            border: 2px solid #a855f7;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Custom Alert Modal Styles */
        .custom-alert-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }
        .custom-alert-modal.visible {
            display: flex;
        }
        .custom-alert-content {
            background-color: #ffffff;
            color: #374151;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            animation: fadeIn 0.3s ease-out;
            border: 1px solid #e2e8f0;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .alert-ok-button {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            margin-top: 1rem;
        }
        .alert-ok-button:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }
        .hidden {
            display: none !important;
        }
        /* Style for disabled message */
        .disabled-message {
            text-align: center;
            padding: 8px;
            border-radius: 12px;
            margin-bottom: 8px;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e40af; /* Darker blue text */
            background-color: #dbeafe; /* Light blue background */
            border: 1px solid #93c5fd; /* Blue border */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- Initial Login Section -->
    <div id="initial-login-section" class="initial-login-container">
        <div class="initial-login-card">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">Welcome to Minecraft Election</h2>
            <p class="mb-6 text-gray-600">Please enter your unique Voting ID to proceed.</p>
            <input type="text" id="voting-id-input-initial" placeholder="Enter Voting ID" class="input-field w-full mb-4">
            <button id="voting-id-login-btn-initial" class="action-button w-full">Login</button>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="main-app-container" class="hidden app-container">
        <!-- Header with Title and Logout -->
        <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-blue-700">Minecraft Election</h1>
            <button id="logout-button" class="bg-red-500 text-white py-2 px-4 rounded-lg shadow hover:bg-red-600 transition duration-300 ease-in-out font-semibold">Logout</button>
        </div>

        <div class="flex flex-col lg:flex-row gap-6 w-full">
            <!-- Main Content Area for Tabs -->
            <div class="main-content-area flex-grow">
                <!-- Tab Navigation -->
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mb-8">
                    <button id="tab-vote" class="tab-button active">Vote</button>
                    <button id="tab-candidate-login" class="tab-button">Candidate Login</button>
                    <button id="tab-register-candidate" class="tab-button">Register Candidate</button>
                </div>

                <!-- Tab Content: Vote Section -->
                <div id="content-vote" class="tab-content">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Cast Your Vote</h2>
                    <div id="vote-section-details">
                        <div id="voting-disabled-message" class="hidden text-center p-8 bg-red-100 border border-red-300 rounded-xl mb-8 text-red-700">
                            <p class="text-xl font-semibold">
                                This Voting ID has already been used. You cannot cast another vote.
                            </p>
                            <p class="text-sm mt-2">You can still view live vote counts and candidate information.</p>
                        </div>

                        <div id="player-info-display" class="mb-6 p-6 bg-blue-50 border border-blue-200 rounded-xl shadow-inner text-blue-800">
                            <h3 class="text-xl font-semibold mb-4">Your Voting Account Details:</h3>
                            <p class="mb-2"><strong>Minecraft Name:</strong> <span id="display-minecraft-name"></span></p>
                            <p><strong>Game Edition:</strong> <span id="display-game-edition"></span></p>
                            <p class="text-sm text-blue-600 mt-2">
                                <span id="bedrock-hint" class="hidden">For Bedrock Edition, your username might include a dot (e.g., `Player.Name`). Please ensure it matches your in-game name.</span>
                            </p>
                        </div>

                        <!-- New Optional Details Section -->
                        <div class="mb-6 p-4 bg-gray-50 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold mb-3 text-gray-700">Optional Details:</h3>
                            <div class="mb-4">
                                <label for="real-name-input" class="block text-sm font-medium text-gray-700 mb-1">Your Real Name (Optional):</label>
                                <input type="text" id="real-name-input" placeholder="e.g., John Doe" class="input-field w-full">
                            </div>
                            <div class="mb-4">
                                <label for="contact-info-input" class="block text-sm font-medium text-gray-700 mb-1">Discord/WhatsApp/Instagram (Optional):</label>
                                <input type="text" id="contact-info-input" placeholder="e.g., @yourdiscord, +1234567890" class="input-field w-full">
                            </div>
                            <div id="entered-details-display" class="mt-4 p-3 bg-white border border-gray-200 rounded-md hidden">
                                <p class="text-sm font-medium text-gray-600">Entered Details:</p>
                                <p id="display-real-name" class="text-sm text-gray-800"></p>
                                <p id="display-contact-info" class="text-sm text-gray-800"></p>
                            </div>
                        </div>

                        <div id="party-list-for-voting" class="hidden mt-6 p-6 bg-gray-50 border border-gray-200 rounded-xl shadow-inner">
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Select a Party to Vote For:</h3>
                            <div id="party-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- Party cards will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Candidate Login -->
                <div id="content-candidate-login" class="tab-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Candidate Login</h2>
                    <div id="party-management-login-section" class="p-6 bg-gray-50 border border-gray-200 rounded-xl shadow-inner">
                        <form id="party-login-form" class="space-y-4">
                            <div>
                                <label for="login-party-name" class="block text-sm font-medium text-gray-700">Party Name:</label>
                                <input type="text" id="login-party-name" class="input-field w-full" required>
                            </div>
                            <div>
                                <label for="login-party-password" class="block text-sm font-medium text-gray-700">Password:</label>
                                <input type="password" id="login-party-password" class="input-field w-full" required>
                            </div>
                            <button type="submit" class="action-button w-full">Login</button>
                        </form>
                    </div>
                    <div id="candidate-dashboard" class="mt-6 p-6 bg-blue-50 border border-blue-200 rounded-xl shadow-inner hidden">
                        <!-- Candidate dashboard content will be loaded here -->
                        <button id="logout-candidate-btn" class="action-button bg-red-600 hover:bg-red-700 w-full mt-4">Logout</button>
                    </div>
                </div>

                <!-- Tab Content: Register Candidate -->
                <div id="content-register-candidate" class="tab-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Register New Candidate</h2>
                    <div class="p-6 bg-gray-50 border border-gray-200 rounded-xl shadow-inner">
                        <form id="register-candidate-form" class="space-y-4">
                            <div>
                                <label for="candidate-name" class="block text-sm font-medium text-gray-700">Candidate Name:</label>
                                <input type="text" id="candidate-name" class="input-field w-full" required>
                            </div>
                            <div>
                                <label for="party-name-reg" class="block text-sm font-medium text-gray-700">Party Name:</label>
                                <input type="text" id="party-name-reg" class="input-field w-full" required>
                            </div>
                            <div>
                                <label for="party-password-reg" class="block text-sm font-medium text-gray-700">Party Password:</label>
                                <input type="password" id="party-password-reg" class="input-field w-full" required>
                            </div>
                            <div>
                                <label for="party-chinn" class="block text-sm font-medium text-gray-700">Party Symbol (Text/Emoji):</label>
                                <input type="text" id="party-chinn" class="input-field w-full" required>
                            </div>
                            <div>
                                <label for="party-logo-upload" class="block text-sm font-medium text-gray-700">Party Logo:</label>
                                <input type="file" id="party-logo-upload" accept="image/*" class="hidden">
                                <button type="button" id="upload-logo-btn" class="action-button mt-1">Upload Logo</button>
                                <img id="logo-preview" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAQAAADa613fAAAAaElEQVR42u3PQREAAAgDoC2G/Yt62e20IIDz9wYBAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgMDbA3cAAR2gLdJPAAAAAElFTkSuQmCC" alt="Logo Preview" class="mt-2 w-24 h-24 object-cover rounded-md border border-gray-300">
                            </div>
                            <button type="submit" class="action-button w-full">Register Party</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sidebar: Live Vote Count -->
            <div class="sidebar-area">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Live Vote Count</h2>
                <div id="live-vote-count" class="space-y-3">
                    <!-- Live vote counts will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="custom-alert-modal">
        <div class="custom-alert-content">
            <p id="alert-message" class="text-lg font-semibold mb-4"></p>
            <button id="alert-ok-btn" class="alert-ok-button">OK</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- DOM Elements ---
            const initialLoginSection = document.getElementById('initial-login-section');
            const votingIdInputInitial = document.getElementById('voting-id-input-initial');
            const votingIdLoginBtnInitial = document.getElementById('voting-id-login-btn-initial');
            const mainAppContainer = document.getElementById('main-app-container');

            // Tab Buttons
            const tabVote = document.getElementById('tab-vote');
            const tabCandidateLogin = document.getElementById('tab-candidate-login');
            const tabRegisterCandidate = document.getElementById('tab-register-candidate');

            // Tab Contents
            const contentVote = document.getElementById('content-vote');
            const contentCandidateLogin = document.getElementById('content-candidate-login');
            const contentRegisterCandidate = document.getElementById('content-register-candidate');

            // Vote Section Elements (after initial login)
            const voteSectionDetails = document.getElementById('vote-section-details');
            const votingDisabledMessage = document.getElementById('voting-disabled-message');
            const playerInfoDisplay = document.getElementById('player-info-display');
            const displayMinecraftName = document.getElementById('display-minecraft-name');
            const displayGameEdition = document.getElementById('display-game-edition');
            const bedrockHint = document.getElementById('bedrock-hint'); // New hint element
            const partyListForVoting = document.getElementById('party-list-for-voting');
            const partyListDiv = document.getElementById('party-list');

            // Optional Details Elements
            const realNameInput = document.getElementById('real-name-input');
            const contactInfoInput = document.getElementById('contact-info-input');
            const enteredDetailsDisplay = document.getElementById('entered-details-display');
            const displayRealName = document.getElementById('display-real-name');
            const displayContactInfo = document.getElementById('display-contact-info');


            // Live Vote Count Elements
            const liveVoteCountDiv = document.getElementById('live-vote-count'); // Correctly defined

            // Candidate Management Elements
            const partyManagementLoginSection = document.getElementById('party-management-login-section');
            const partyLoginForm = document.getElementById('party-login-form');
            const candidateDashboard = document.getElementById('candidate-dashboard');
            const logoutCandidateBtn = document.getElementById('logout-candidate-btn');

            // Register Candidate Elements
            const registerCandidateForm = document.getElementById('register-candidate-form');
            const logoPreview = document.getElementById('logo-preview');
            const uploadLogoBtn = document.getElementById('upload-logo-btn');
            const partyLogoUpload = document.getElementById('party-logo-upload');

            // Custom Alert Modal Elements
            const customAlertModal = document.getElementById('custom-alert-modal');
            const alertMessage = document.getElementById('alert-message');
            const alertOkBtn = document.getElementById('alert-ok-btn');

            // --- Feature Toggles and Custom Messages ---
            const IS_VOTING_ENABLED = false; // Set to false to disable voting
            const VOTING_DISABLED_CUSTOM_MESSAGE = "Voting is tomorrow. Please check back tomorrow at 1 pm !";

            const IS_REGISTRATION_ENABLED = true; // Set to false to disable candidate registration
            const REGISTRATION_DISABLED_CUSTOM_MESSAGE = "Candidate registration is not available at this time.";
            // --- End Feature Toggles ---

            // --- Constants & State Variables ---
            const API_BASE_URL = 'https://voting.1987sakshamsingh.workers.dev/api';
            const placeholderImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAQAAADa613fAAAAaElEQVR42u3PQREAAAgDoC2G/Yt62e20IIDz9wYBAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgMDbA3cAAR2gLdJPAAAAAElFTkSuQmCC';
            const MAX_IMAGE_SIZE_KB = 100; // Set image size limit to 100KB

            let candidates = [];
            let votes = [];
            let currentVotingId = sessionStorage.getItem('currentVotingId') || null;
            let currentVotingPlayerDetails = JSON.parse(sessionStorage.getItem('currentVotingPlayerDetails')) || null;
            let loggedInCandidate = JSON.parse(sessionStorage.getItem('loggedInCandidate')) || null;
            let isVotingDisabledForUsedId = false;

            // --- API Fetch Functions ---
            async function fetchData(endpoint) {
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`API Error fetching ${endpoint}: ${response.status} - ${errorText}`);
                        showCustomAlert(`Error loading data: ${response.statusText}`);
                        return null;
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Network error fetching ${endpoint}:`, error);
                    showCustomAlert(`Network error: Could not connect to server.`);
                    return null;
                }
            }

            async function postData(endpoint, data) {
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`API Error posting to ${endpoint}: ${response.status} - ${errorText}`);
                        showCustomAlert(`Error: ${errorText || response.statusText}`);
                        return null;
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Network error posting to ${endpoint}:`, error);
                    showCustomAlert(`Network error: Could not connect to server.`);
                    return null;
                }
            }

            // --- Helper Functions ---
            function showCustomAlert(message) {
                alertMessage.textContent = message;
                customAlertModal.classList.add('visible');
            }

            function hideCustomAlert() {
                customAlertModal.classList.remove('visible');
            }

            function getPartyVoteCount(partyName) {
                return votes.filter(vote => vote.party === partyName).length;
            }

            // --- UI Management Functions ---

            /**
             * Shows a specific tab content and activates its button.
             * @param {HTMLElement} tabContentToShow - The content div to display.
             * @param {HTMLElement} tabButtonToActivate - The button to mark as active.
             */
            function showTab(tabContentToShow, tabButtonToActivate) {
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                // Deactivate all tab buttons
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                });

                // Show the selected tab content
                tabContentToShow.classList.remove('hidden');
                // Activate the selected tab button
                tabButtonToActivate.classList.add('active');

                // Perform specific updates for each tab
                if (tabContentToShow === contentVote) {
                    updateVoteSectionUI();
                } else if (tabContentToShow === contentCandidateLogin) {
                    displayCandidateDashboard(); // Show login form or dashboard
                } else if (tabContentToShow === contentRegisterCandidate) {
                    // No specific update needed on tab switch, form is always visible
                }
            }

            /**
             * Updates the UI of the Vote section based on login status and voting ID usage.
             */
            function updateVoteSectionUI() {
                // This function is now only called AFTER a successful initial login

                // Check if voting is generally enabled
                if (!IS_VOTING_ENABLED) {
                    voteSectionDetails.classList.remove('hidden'); // Ensure container is visible for message
                    playerInfoDisplay.classList.add('hidden');
                    realNameInput.classList.add('hidden');
                    contactInfoInput.classList.add('hidden');
                    enteredDetailsDisplay.classList.add('hidden');
                    partyListForVoting.classList.add('hidden');
                    votingDisabledMessage.classList.remove('hidden');
                    votingDisabledMessage.innerHTML = `<p class="text-xl font-semibold">${VOTING_DISABLED_CUSTOM_MESSAGE}</p>`;
                    votingDisabledMessage.classList.remove('bg-red-100', 'border-red-300', 'text-red-700');
                    votingDisabledMessage.classList.add('disabled-message'); // Apply custom style
                    return; // Exit early if voting is disabled
                }

                voteSectionDetails.classList.remove('hidden');

                // Display player info from the validated voting ID
                displayMinecraftName.textContent = currentVotingPlayerDetails.playerName || 'N/A';
                displayGameEdition.textContent = currentVotingPlayerDetails.gameEdition || 'N/A';
                playerInfoDisplay.classList.remove('hidden');

                if (currentVotingPlayerDetails.gameEdition === 'Bedrock') {
                    bedrockHint.classList.remove('hidden');
                } else {
                    bedrockHint.classList.add('hidden');
                }

                // Update entered details display dynamically as user types
                realNameInput.addEventListener('input', updateEnteredDetailsDisplay);
                contactInfoInput.addEventListener('input', updateEnteredDetailsDisplay);
                updateEnteredDetailsDisplay(); // Initial call to set display based on current values


                if (isVotingDisabledForUsedId) {
                    votingDisabledMessage.classList.remove('hidden');
                    votingDisabledMessage.innerHTML = `
                        <p class="text-xl font-semibold">
                            This Voting ID has already been used. You cannot cast another vote.
                        </p>
                        <p class="text-sm mt-2">You can still view live vote counts and candidate information.</p>
                    `;
                    votingDisabledMessage.classList.add('bg-red-100', 'border-red-300', 'text-red-700');
                    votingDisabledMessage.classList.remove('disabled-message'); // Remove custom style if it was applied
                    partyListForVoting.classList.add('hidden');
                } else {
                    votingDisabledMessage.classList.add('hidden');
                    partyListForVoting.classList.remove('hidden');
                    displayPartyList(); // Only display party list if voting is enabled
                }
            }

            function updateEnteredDetailsDisplay() {
                displayRealName.textContent = `Real Name: ${realNameInput.value}`;
                displayContactInfo.textContent = `Contact: ${contactInfoInput.value}`;
                if (realNameInput.value || contactInfoInput.value) {
                    enteredDetailsDisplay.classList.remove('hidden');
                } else {
                    enteredDetailsDisplay.classList.add('hidden');
                }
            }


            /**
             * Updates and displays the live vote count for all parties.
             */
            async function updateLiveVoteCount() {
                votes = await fetchData('/votes');
                if (!votes) return;

                liveVoteCountDiv.innerHTML = '';
                const voteCounts = {};

                // Initialize counts for all known candidates
                candidates.forEach(c => voteCounts[c.partyName] = 0);

                votes.forEach(vote => {
                    if (voteCounts.hasOwnProperty(vote.party)) { // Ensure party exists
                        voteCounts[vote.party] = (voteCounts[vote.party] || 0) + 1;
                    }
                });

                const sortedVoteCounts = Object.entries(voteCounts).sort(([, countA], [, countB]) => countB - countA);

                if (sortedVoteCounts.length > 0) {
                    sortedVoteCounts.forEach(([party, count]) => {
                        const partyData = candidates.find(c => c.partyName === party);
                        const div = document.createElement('div');
                        div.classList.add('vote-count-item', 'flex', 'items-center', 'p-2', 'bg-gray-50', 'rounded-md', 'shadow-sm', 'text-gray-800');

                        if (partyData && partyData.partyLogo) {
                            const logo = document.createElement('img');
                            logo.src = partyData.partyLogo;
                            logo.alt = partyData.partyName;
                            logo.classList.add('party-logo-small');
                            div.appendChild(logo);
                        } else if (partyData && partyData.partyChinn) {
                            const symbolSpan = document.createElement('span');
                            symbolSpan.textContent = partyData.partyChinn;
                            symbolSpan.classList.add('text-2xl', 'mr-2');
                            div.appendChild(symbolSpan);
                        }


                        const text = document.createElement('span');
                        text.textContent = `${party}: ${count} votes`;
                        div.appendChild(text);

                        liveVoteCountDiv.appendChild(div);
                    });
                } else {
                    liveVoteCountDiv.innerHTML = '<p class="text-center text-gray-500">No votes cast yet.</p>';
                    liveVoteCountDiv.classList.add('text-center', 'text-gray-500');
                }
            }

            /**
             * Displays the list of registered parties for voting.
             */
            async function displayPartyList() {
                candidates = await fetchData('/candidates');
                if (!candidates) return;

                partyListDiv.innerHTML = '';
                if (candidates.length === 0) {
                    partyListDiv.innerHTML = '<p class="text-center text-gray-500">No parties registered yet. Be the first to register!</p>';
                    partyListDiv.classList.add('text-center', 'text-gray-500');
                    return;
                }

                candidates.forEach(candidate => {
                    const partyCard = document.createElement('div');
                    partyCard.classList.add('party-card', 'bg-white', 'p-4', 'rounded-lg', 'shadow-md', 'flex', 'flex-col', 'items-center', 'text-center', 'border', 'border-gray-200');

                    const partyLogo = document.createElement('img');
                    partyLogo.src = candidate.partyLogo || placeholderImage;
                    partyLogo.alt = candidate.partyName;
                    partyLogo.classList.add('w-24', 'h-24', 'object-cover', 'rounded-full', 'mb-4', 'border', 'border-gray-300');

                    const partyName = document.createElement('h3');
                    partyName.textContent = candidate.partyName;
                    partyName.classList.add('text-xl', 'font-semibold', 'mb-2', 'text-gray-800');

                    const partyLeader = document.createElement('p');
                    partyLeader.textContent = `Leader: ${candidate.candidateName}`;
                    partyLeader.classList.add('text-gray-600', 'text-sm');

                    const partyChinn = document.createElement('p');
                    partyChinn.textContent = `Symbol: ${candidate.partyChinn}`;
                    partyChinn.classList.add('text-gray-600', 'text-sm', 'mb-4');

                    const voteButton = document.createElement('button');
                    voteButton.textContent = 'Vote for this Party';
                    voteButton.classList.add('action-button', 'w-full');
                    voteButton.addEventListener('click', async () => {
                        if (!currentVotingId) {
                            showCustomAlert('Please log in with your Voting ID first.');
                            return;
                        }
                        if (isVotingDisabledForUsedId) {
                            showCustomAlert('This Voting ID has already been used. You cannot cast another vote.');
                            return;
                        }
                        // Check IS_VOTING_ENABLED before allowing vote submission
                        if (!IS_VOTING_ENABLED) {
                            showCustomAlert(VOTING_DISABLED_CUSTOM_MESSAGE);
                            return;
                        }


                        const voteData = {
                            votingId: currentVotingId,
                            party: candidate.partyName,
                            realName: realNameInput.value, // Include optional real name
                            discordInsta: contactInfoInput.value // Include optional contact info
                        };

                        const result = await postData('/submit-vote', voteData);
                        if (result && result.success) {
                            showCustomAlert(`You have successfully voted for ${candidate.partyName}!`);
                            isVotingDisabledForUsedId = true;
                            sessionStorage.setItem('isVotingDisabledForUsedId', 'true');
                            updateVoteSectionUI();
                            await updateLiveVoteCount();
                        } else {
                            showCustomAlert(result ? result.message : 'Failed to submit vote.');
                        }
                    });

                    partyCard.appendChild(partyLogo);
                    partyCard.appendChild(partyName);
                    partyCard.appendChild(partyLeader);
                    partyCard.appendChild(partyChinn);
                    partyCard.appendChild(voteButton);
                    partyListDiv.appendChild(partyCard);
                });
            }

            /**
             * Handles candidate login.
             */
            async function loginCandidate(partyName, password) {
                candidates = await fetchData('/candidates');
                if (!candidates) return;

                // Passwords are stored base64 encoded
                loggedInCandidate = candidates.find(c => c.partyName === partyName && c.password === btoa(password));

                if (loggedInCandidate) {
                    sessionStorage.setItem('loggedInCandidate', JSON.stringify(loggedInCandidate));
                    showCustomAlert('Login successful! Welcome to your dashboard.');
                    displayCandidateDashboard();
                } else {
                    showCustomAlert('Invalid Party Name or Password.');
                    loggedInCandidate = null;
                    sessionStorage.removeItem('loggedInCandidate');
                    displayCandidateDashboard();
                }
            }

            /**
             * Handles candidate logout.
             */
            function logoutCandidate() {
                loggedInCandidate = null;
                sessionStorage.removeItem('loggedInCandidate');
                displayCandidateDashboard();
                showCustomAlert('Logged out successfully.');
            }

            /**
             * Displays the candidate's dashboard if logged in, or the login form otherwise.
             */
            async function displayCandidateDashboard() {
                if (loggedInCandidate) {
                    partyManagementLoginSection.classList.add('hidden');
                    candidateDashboard.classList.remove('hidden');
                    await updateLiveVoteCount(); // Ensure votes are fresh for dashboard

                    candidateDashboard.innerHTML = `
                        <h3 class="text-xl font-semibold mb-2 text-gray-800">Welcome, ${loggedInCandidate.candidateName}!</h3>
                        <p class="text-gray-600">Party: ${loggedInCandidate.partyName}</p>
                        <p class="text-gray-600 mb-4">Symbol: ${loggedInCandidate.partyChinn}</p>
                        <img src="${loggedInCandidate.partyLogo}" alt="${loggedInCandidate.partyName}" class="party-logo-large mb-4">
                        <p class="text-lg font-bold text-gray-800">Your party currently has <strong>${getPartyVoteCount(loggedInCandidate.partyName)}</strong> votes.</p>
                        <button id="logout-candidate-btn" class="action-button bg-red-600 hover:bg-red-700 w-full mt-4">Logout</button>
                    `;
                    document.getElementById('logout-candidate-btn').addEventListener('click', logoutCandidate);
                } else {
                    partyManagementLoginSection.classList.remove('hidden');
                    candidateDashboard.classList.add('hidden');
                    partyLoginForm.reset();
                }
            }

            // --- Event Listeners ---

            // Custom Alert OK button
            alertOkBtn.addEventListener('click', hideCustomAlert);

            // Initial Voting ID Login Button
            votingIdLoginBtnInitial.addEventListener('click', async () => {
                const id = votingIdInputInitial.value.trim();
                if (!id) {
                    showCustomAlert('Please enter your Voting ID.');
                    return;
                }

                const result = await postData('/check-voting-id', { votingId: id });

                if (result && result.success && result.valid) {
                    currentVotingId = id;
                    sessionStorage.setItem('currentVotingId', currentVotingId);
                    currentVotingPlayerDetails = {
                        playerName: result.playerName,
                        gameEdition: result.gameEdition
                    };
                    sessionStorage.setItem('currentVotingPlayerDetails', JSON.stringify(currentVotingPlayerDetails));

                    if (result.used) {
                        isVotingDisabledForUsedId = true;
                        sessionStorage.setItem('isVotingDisabledForUsedId', 'true');
                        showCustomAlert('Login successful, but this Voting ID has already been used. You cannot vote again.');
                    } else {
                        isVotingDisabledForUsedId = false;
                        sessionStorage.removeItem('isVotingDisabledForUsedId');
                        showCustomAlert('Login successful! Welcome.');
                    }

                    initialLoginSection.classList.add('hidden');
                    mainAppContainer.classList.remove('hidden');
                    showTab(contentVote, tabVote); // Automatically go to Vote tab
                    await updateLiveVoteCount();
                    await displayPartyList();
                } else {
                    showCustomAlert(result ? result.message : 'Invalid Voting ID.');
                }
            });

            // Logout Button (for general app logout)
            document.getElementById('logout-button').addEventListener('click', () => {
                sessionStorage.clear(); // Clear all session data
                currentVotingId = null;
                currentVotingPlayerDetails = null;
                loggedInCandidate = null;
                isVotingDisabledForUsedId = false;

                initialLoginSection.classList.remove('hidden'); // Show initial login
                mainAppContainer.classList.add('hidden'); // Hide main app

                votingIdInputInitial.value = ''; // Clear initial ID input
                partyLoginForm.reset(); // Clear party login form
                registerCandidateForm.reset(); // Clear register form
                logoPreview.src = placeholderImage; // Reset logo preview

                showCustomAlert('Logged out successfully.');
            });


            // Tab Navigation Buttons
            tabVote.addEventListener('click', () => showTab(contentVote, tabVote));
            tabCandidateLogin.addEventListener('click', () => showTab(contentCandidateLogin, tabCandidateLogin));
            tabRegisterCandidate.addEventListener('click', () => showTab(contentRegisterCandidate, tabRegisterCandidate));

            // Party Logo Upload
            uploadLogoBtn.addEventListener('click', () => {
                partyLogoUpload.click();
            });

            partyLogoUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    // Changed MAX_IMAGE_SIZE_MB to MAX_IMAGE_SIZE_KB and updated calculation
                    if (file.size > MAX_IMAGE_SIZE_KB * 1024) {
                        showCustomAlert(`Image size should be less than ${MAX_IMAGE_SIZE_KB}KB.`);
                        event.target.value = '';
                        logoPreview.src = placeholderImage;
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        logoPreview.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Register Candidate Form Submission
            registerCandidateForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Check if registration is generally enabled
                if (!IS_REGISTRATION_ENABLED) {
                    showCustomAlert(REGISTRATION_DISABLED_CUSTOM_MESSAGE);
                    return;
                }

                const candidateName = document.getElementById('candidate-name').value;
                const partyName = document.getElementById('party-name-reg').value;
                const partyPassword = document.getElementById('party-password-reg').value;
                const partyChinn = document.getElementById('party-chinn').value;
                const partyLogo = logoPreview.src;

                const newCandidate = {
                    candidateName,
                    partyName,
                    password: btoa(partyPassword), // Base64 encode password for storage
                    partyChinn,
                    partyLogo
                };

                const result = await postData('/register-candidate', newCandidate);

                if (result && result.success) {
                    showCustomAlert('Candidate registered successfully!');
                    registerCandidateForm.reset();
                    logoPreview.src = placeholderImage;
                    // Automatically log in the new candidate
                    await loginCandidate(partyName, partyPassword);
                    await Promise.all([updateLiveVoteCount(), displayPartyList()]);
                } else {
                    showCustomAlert(result ? result.message : 'Failed to register candidate.');
                }
            });

            // Party Login Form Submission
            partyLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const loginPartyName = document.getElementById('login-party-name').value;
                const loginPartyPassword = document.getElementById('login-party-password').value;
                loginCandidate(loginPartyName, loginPartyPassword);
            });

            // --- Initial Setup on Load ---
            // Hide registration tab and content if disabled
            if (!IS_REGISTRATION_ENABLED) {
                tabRegisterCandidate.classList.add('hidden'); // Hide the tab button
                contentRegisterCandidate.innerHTML = `
                    <div class="disabled-message">
                        <p>${REGISTRATION_DISABLED_CUSTOM_MESSAGE}</p>
                    </div>
                `;
                // Ensure the form is hidden if the tab is not enabled
                document.getElementById('register-candidate-form').classList.add('hidden');
            }


            // Determine which screen to show on page load
            if (currentVotingId) {
                // Attempt to retrieve stored voting ID data
                const storedVotingIdData = sessionStorage.getItem('currentVotingPlayerDetails');
                if (storedVotingIdData) {
                    try {
                        currentVotingPlayerDetails = JSON.parse(storedVotingIdData);
                    } catch (e) {
                        console.error("Error parsing stored currentVotingPlayerDetails:", e);
                        sessionStorage.removeItem('currentVotingPlayerDetails'); // Clear invalid data
                        currentVotingId = null; // Force re-login
                    }
                }

                if (currentVotingId && currentVotingPlayerDetails) { // Proceed only if both are valid
                    initialLoginSection.classList.add('hidden');
                    mainAppContainer.classList.remove('hidden');
                    isVotingDisabledForUsedId = sessionStorage.getItem('isVotingDisabledForUsedId') === 'true';
                    updateVoteSectionUI(); // Now currentVotingIdData should be available
                    await Promise.all([updateLiveVoteCount(), displayPartyList(), displayCandidateDashboard()]);
                    showTab(contentVote, tabVote);
                } else {
                    // If currentVotingId exists but data is missing/corrupted, force login screen
                    console.warn("Voting ID found but data missing or corrupted. Redirecting to login.");
                    sessionStorage.removeItem('currentVotingId');
                    sessionStorage.removeItem('currentVotingPlayerDetails');
                    sessionStorage.removeItem('isVotingDisabledForUsedId');
                    initialLoginSection.classList.remove('hidden');
                    mainAppContainer.classList.add('hidden');
                    // No specific tab to show here, as it's the initial login screen
                }
            } else if (loggedInCandidate) {
                initialLoginSection.classList.add('hidden');
                mainAppContainer.classList.remove('hidden');
                await Promise.all([updateLiveVoteCount(), displayPartyList(), displayCandidateDashboard()]);
                showTab(contentCandidateLogin, tabCandidateLogin);
            } else {
                initialLoginSection.classList.remove('hidden');
                mainAppContainer.classList.add('hidden');
                // No specific tab to show here, as it's the initial login screen
            }
        });
    </script>
</body>
</html>
