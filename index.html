
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Election</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
   <style>
    /* Custom styles for the app */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    /* Keyframes for animations */
    @keyframes pulse-shadow {
        0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
        100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
    }
    
    @keyframes button-press {
        0% { transform: scale(1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
        100% { transform: scale(0.98) translateY(1px); box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
    }

    /* Base Styling */
    body {
        font-family: 'Inter', sans-serif;
        /* Cooler, deeper blue/purple gradient */
        background: linear-gradient(135deg, #1e3a8a 0%, #4f46e5 100%); 
        color: #e2e8f0; /* Light gray text for contrast */
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        transition: background-color 0.5s ease;
    }

    /* Initial Login Screen */
    .initial-login-container {
        /* Preserve positioning */
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        position: fixed; 
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1e3a8a 0%, #4f46e5 100%); 
        z-index: 999; 
    }
    .initial-login-card {
        background-color: #ffffff;
        border-radius: 1.5rem; 
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); /* Stronger, cooler shadow */
        padding: 2.5rem;
        max-width: 400px; 
        width: 90%; 
        text-align: center;
        border: 1px solid #e2e8f0;
        animation: fadeIn 0.5s ease-out;
    }
    .initial-login-card h2 {
        color: #3b82f6; /* Blue title */
    }

    /* Main App Container */
    .app-container {
        background-color: #ffffff;
        border-radius: 2rem; /* More rounded */
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.35); /* Prominent shadow */
        padding: 3rem; /* Slightly more padding */
        max-width: 1300px; 
        width: 100%;
        display: flex;
        flex-direction: column; 
        gap: 2rem; 
        min-height: 80vh; 
        transition: all 0.5s ease; /* Smooth transition for resizing/state changes */
    }

    /* Main content and sidebar areas */
    .main-content-area, .sidebar-area {
        background-color: #f7f9fd; /* Very light, off-white background */
        border-radius: 1.5rem; 
        padding: 2rem;
        box-shadow: inset 0 1px 5px rgba(0,0,0,0.08); /* Better inner shadow */
        border: 1px solid #eef2ff;
        flex-grow: 1; 
        transition: transform 0.3s ease-out, box-shadow 0.3s ease-out;
    }
    .main-content-area:hover, .sidebar-area:hover {
        transform: translateY(-2px);
        box-shadow: inset 0 1px 5px rgba(0,0,0,0.08), 0 5px 15px rgba(0,0,0,0.05);
    }
    @media (min-width: 1024px) { 
        .app-container {
            flex-direction: row; 
        }
        .main-content-area {
            flex: 3; 
        }
        .sidebar-area {
            flex: 1; 
        }
    }

    /* Tab button styles (Cooler, with active indicator) */
    .tab-button {
        background-color: transparent; /* Make background transparent */
        color: #64748b; /* Slate text for inactive */
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        font-weight: 600;
        transition: all 0.3s ease;
        position: relative;
        flex-grow: 1; 
        text-align: center; 
        border: none;
    }
    .tab-button::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 0%;
        height: 4px;
        background: #3b82f6;
        border-radius: 2px;
        transition: width 0.3s ease-out;
    }
    .tab-button:hover {
        color: #3b82f6; /* Blue on hover */
    }
    .tab-button.active {
        color: #1e3a8a; /* Darker blue text for active */
        font-weight: 700;
    }
    .tab-button.active::after {
        width: 100%; /* Full width blue underline for active */
        background: linear-gradient(to right, #3b82f6, #6366f1);
    }

    /* Input field styles - Added focus glow */
    .input-field {
        background-color: #f1f5f9; 
        border: 1px solid #cbd5e0;
        color: #374151;
        padding: 0.75rem;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
    }
    .input-field::placeholder {
        color: #94a3b8;
    }
    .input-field:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2); /* Glow effect */
    }

    /* Action button styles (3D Press Effect) */
    .action-button {
        background: linear-gradient(to right, #3b82f6, #6366f1); 
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        font-weight: 600;
        transition: all 0.15s ease-out;
        box-shadow: 0 4px 0 0 #3649a9; /* Base 3D shadow */
        border: none;
        cursor: pointer;
    }
    .action-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 5px 0 0 #3649a9;
    }
    .action-button:active {
        transform: translateY(3px); /* Press down */
        box-shadow: 0 1px 0 0 #3649a9; /* Reduce shadow to simulate press */
    }
    /* Disabled button style */
    .action-button:disabled {
        background: #cbd5e0; 
        color: #94a3b8; 
        cursor: not-allowed;
        transform: none;
        box-shadow: 0 4px 0 0 #a0aec0; /* Adjusted disabled 3D shadow */
    }

    /* Party card styles - Enhanced box effect with hover animation */
    .party-card {
        background-color: #ffffff;
        border: 1px solid #e0e7ff; 
        border-radius: 1.5rem; /* More rounded */
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smoother transition */
        box-shadow: 0 5px 15px rgba(0,0,0,0.08); /* Subtle initial shadow */
        display: flex; 
        flex-direction: column;
        align-items: center;
        justify-content: space-between; 
        min-width: 180px; 
    }
    .party-card:hover {
        transform: translateY(-8px); /* Lift significantly */
        box-shadow: 0 15px 30px rgba(0,0,0,0.15); /* Deepen shadow */
        border-color: #6366f1; /* Highlight border */
    }
    .party-logo-small {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 50%;
        margin-right: 10px;
        border: 2px solid #a855f7; 
        transition: transform 0.3s ease;
    }
    .party-card:hover .party-logo-small {
        transform: scale(1.1) rotate(5deg);
    }
    .party-logo-large {
        max-width: 120px;
        height: auto;
        border-radius: 1rem;
        margin-top: 10px;
        border: 3px solid #6366f1; /* Stronger border */
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    /* Custom Alert Modal Styles - Added a pop animation */
    .custom-alert-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.7); /* Darker overlay */
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(4px); /* Subtle blur effect */
    }
    .custom-alert-modal.visible {
        display: flex;
    }
    .custom-alert-content {
        background-color: #ffffff;
        color: #374151;
        padding: 3rem; /* More padding */
        border-radius: 1.5rem;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        animation: fadeIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Spring-like pop */
        border: 1px solid #e2e8f0;
        max-width: 450px;
        width: 90%;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.8); }
        to { opacity: 1; transform: scale(1); }
    }
    .alert-ok-button {
        /* Inherit action-button styles for consistency */
        background: linear-gradient(to right, #3b82f6, #6366f1); 
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        font-weight: 600;
        transition: all 0.15s ease-out;
        box-shadow: 0 4px 0 0 #3649a9; 
        border: none;
        margin-top: 1rem;
    }
    .alert-ok-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 5px 0 0 #3649a9;
    }
    .alert-ok-button:active {
        transform: translateY(3px); 
        box-shadow: 0 1px 0 0 #3649a9; 
    }
    .hidden {
        display: none !important;
    }

    /* Style for disabled message */
    .disabled-message {
        text-align: center;
        padding: 1rem;
        border-radius: 1rem;
        margin-bottom: 1rem;
        font-size: 1.25rem;
        font-weight: 700;
        color: #9d174d; /* Rose red text */
        background-color: #fce7f3; /* Light pink background */
        border: 2px solid #f472b6; /* Pink border */
        animation: pulse-shadow 2s infinite; /* Subtle animation for urgency */
    }
</style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- Initial Login Section -->
    <div id="initial-login-section" class="initial-login-container">
        <div class="initial-login-card">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">Welcome to Minecraft Election</h2>
            <p class="mb-6 text-gray-600">Please enter your unique Voting ID to proceed.</p>
            <input type="text" id="voting-id-input-initial" placeholder="Enter Voting ID" class="input-field w-full mb-4">
            <button id="voting-id-login-btn-initial" class="action-button w-full">Login</button>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="main-app-container" class="hidden app-container">
        <!-- Header with Title and Logout -->
        <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-blue-700">Minecraft Election</h1>
            <button id="logout-button" class="bg-red-500 text-white py-2 px-4 rounded-lg shadow hover:bg-red-600 transition duration-300 ease-in-out font-semibold">Logout</button>
        </div>

        <div class="flex flex-col lg:flex-row gap-6 w-full">
            <!-- Main Content Area for Tabs -->
            <div class="main-content-area flex-grow">
                <!-- Tab Navigation -->
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mb-8">
                    <button id="tab-vote" class="tab-button active">Vote</button>
                    <button id="tab-candidate-login" class="tab-button">Candidate Login</button>
                    <button id="tab-register-candidate" class="tab-button">Register Candidate</button>
                </div>

                <!-- Tab Content: Vote Section -->
                <div id="content-vote" class="tab-content">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Cast Your Vote</h2>
                    <div id="vote-section-details">
                        <div id="voting-disabled-message" class="hidden text-center p-8 bg-red-100 border border-red-300 rounded-xl mb-8 text-red-700">
                            <p class="text-xl font-semibold">
                                This Voting ID has already been used. You cannot cast another vote.
                            </p>
                            <p class="text-sm mt-2">You can still view live vote counts and candidate information.</p>
                        </div>

                        <div id="player-info-display" class="mb-6 p-6 bg-blue-50 border border-blue-200 rounded-xl shadow-inner text-blue-800">
                            <h3 class="text-xl font-semibold mb-4">Your Voting Account Details:</h3>
                            <p class="mb-2"><strong>Minecraft Name:</strong> <span id="display-minecraft-name"></span></p>
                            <p><strong>Game Edition:</strong> <span id="display-game-edition"></span></p>
                            <p class="text-sm text-blue-600 mt-2">
                                <span id="bedrock-hint" class="hidden">For Bedrock Edition, your username might include a dot (e.g., `Player.Name`). Please ensure it matches your in-game name.</span>
                            </p>
                        </div>

                        <!-- New Optional Details Section -->
                        <div class="mb-6 p-4 bg-gray-50 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold mb-3 text-gray-700">Optional Details:</h3>
                            <div class="mb-4">
                                <label for="real-name-input" class="block text-sm font-medium text-gray-700 mb-1">Your Real Name (Optional):</label>
                                <input type="text" id="real-name-input" placeholder="e.g., John Doe" class="input-field w-full">
                            </div>
                            <div class="mb-4">
                                <label for="contact-info-input" class="block text-sm font-medium text-gray-700 mb-1">Discord/WhatsApp/Instagram (Optional):</label>
                                <input type="text" id="contact-info-input" placeholder="e.g., @yourdiscord, +1234567890" class="input-field w-full">
                            </div>
                            <div id="entered-details-display" class="mt-4 p-3 bg-white border border-gray-200 rounded-md hidden">
                                <p class="text-sm font-medium text-gray-600">Entered Details:</p>
                                <p id="display-real-name" class="text-sm text-gray-800"></p>
                                <p id="display-contact-info" class="text-sm text-gray-800"></p>
                            </div>
                        </div>

                        <div id="party-list-for-voting" class="hidden mt-6 p-6 bg-gray-50 border border-gray-200 rounded-xl shadow-inner">
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Select a Party to Vote For:</h3>
                            <!-- Party Search Input -->
                            <div class="mb-4">
                                <label for="party-search-input" class="block text-sm font-medium text-gray-700 mb-1">Search Party by Name, Leader, or Symbol:</label>
                                <input type="text" id="party-search-input" placeholder="e.g., Sovereign, Yash, Lion" class="input-field w-full">
                            </div>
                            <div id="party-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                <!-- Party cards will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Candidate Login -->
                <div id="content-candidate-login" class="tab-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Candidate Login</h2>
                    <div id="party-management-login-section" class="p-6 bg-gray-50 border border-gray-200 rounded-xl shadow-inner">
                        <form id="party-login-form" class="space-y-4">
                            <div>
                                <label for="login-party-name" class="block text-sm font-medium text-gray-700">Party Name:</label>
                                <input type="text" id="login-party-name" class="input-field w-full" required>
                            </div>
                            <div>
                                <label for="login-party-password" class="block text-sm font-medium text-gray-700">Password:</label>
                                <input type="password" id="login-party-password" class="input-field w-full" required>
                            </div>
                            <button type="submit" class="action-button w-full">Login</button>
                        </form>
                    </div>
                    <div id="candidate-dashboard" class="mt-6 p-6 bg-blue-50 border border-blue-200 rounded-xl shadow-inner hidden">
                        <!-- Candidate dashboard content will be loaded here -->
                        <button id="logout-candidate-btn" class="action-button bg-red-600 hover:bg-red-700 w-full mt-4">Logout</button>
                    </div>
                </div>

                <!-- Tab Content: Register Candidate -->
                <div id="content-register-candidate" class="tab-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Register New Candidate</h2>
                    <div class="p-6 bg-gray-50 border border-gray-200 rounded-xl shadow-inner">
                        <form id="register-candidate-form" class="space-y-4">
                            <div>
                                <label for="candidate-name" class="block text-sm font-medium text-gray-700">Candidate Name:</label>
                                <input type="text" id="candidate-name" class="input-field w-full" required>
                            </div>
                            <div>
                                <label for="party-name-reg" class="block text-sm font-medium text-gray-700">Party Name:</label>
                                <input type="text" id="party-name-reg" class="input-field w-full" required>
                            </div>
                            <div>
                                <label for="party-password-reg" class="block text-sm font-medium text-gray-700">Party Password:</label>
                                <input type="password" id="party-password-reg" class="input-field w-full" required>
                            </div>
                            <div>
                                <label for="party-chinn" class="block text-sm font-medium text-gray-700">Party Symbol (Text/Emoji):</label>
                                <input type="text" id="party-chinn" class="input-field w-full" required>
                            </div>
                            <div>
                                <label for="party-logo-upload" class="block text-sm font-medium text-gray-700">Party Logo:</label>
                                <input type="file" id="party-logo-upload" accept="image/*" class="hidden">
                                <button type="button" id="upload-logo-btn" class="action-button mt-1">Upload Logo</button>
                                <img id="logo-preview" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAQAAADa613fAAAAaElEQVR42u3PQREAAAgDoC2G/Yt62e20IIDz9wYBAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgMDbA3cAAR2gLdJPAAAAAElFTSuQmCC" alt="Logo Preview" class="mt-2 w-24 h-24 object-cover rounded-md border border-gray-300">
                            </div>
                            <button type="submit" class="action-button w-full">Register Party</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sidebar: Live Vote Count -->
            <div class="sidebar-area">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Live Vote Count</h2>
                <div id="live-vote-count" class="space-y-3">
                    <!-- Live vote counts will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="custom-alert-modal">
        <div class="custom-alert-content">
            <p id="alert-message" class="text-lg font-semibold mb-4"></p>
            <button id="alert-ok-btn" class="alert-ok-button">OK</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- DOM Elements ---
            const initialLoginSection = document.getElementById('initial-login-section');
            const votingIdInputInitial = document.getElementById('voting-id-input-initial');
            const votingIdLoginBtnInitial = document.getElementById('voting-id-login-btn-initial');
            const mainAppContainer = document.getElementById('main-app-container');

            // Tab Buttons
            const tabVote = document.getElementById('tab-vote');
            const tabCandidateLogin = document.getElementById('tab-candidate-login');
            const tabRegisterCandidate = document.getElementById('tab-register-candidate');

            // Tab Contents
            const contentVote = document.getElementById('content-vote');
            const contentCandidateLogin = document.getElementById('content-candidate-login');
            const contentRegisterCandidate = document.getElementById('content-register-candidate');

            // Vote Section Elements (after initial login)
            const voteSectionDetails = document.getElementById('vote-section-details');
            const votingDisabledMessage = document.getElementById('voting-disabled-message');
            const playerInfoDisplay = document.getElementById('player-info-display');
            const displayMinecraftName = document.getElementById('display-minecraft-name');
            const displayGameEdition = document.getElementById('display-game-edition');
            const bedrockHint = document.getElementById('bedrock-hint'); // New hint element
            const partyListForVoting = document.getElementById('party-list-for-voting');
            const partyListDiv = document.getElementById('party-list');
            const partySearchInput = document.getElementById('party-search-input'); // New search input element

            // Optional Details Elements
            const realNameInput = document.getElementById('real-name-input');
            const contactInfoInput = document.getElementById('contact-info-input');
            const enteredDetailsDisplay = document.getElementById('entered-details-display');
            const displayRealName = document.getElementById('display-real-name');
            const displayContactInfo = document.getElementById('display-contact-info');


            // Live Vote Count Elements
            const liveVoteCountDiv = document.getElementById('live-vote-count'); // Correctly defined

            // Candidate Management Elements
            const partyManagementLoginSection = document.getElementById('party-management-login-section');
            const partyLoginForm = document.getElementById('party-login-form');
            const candidateDashboard = document.getElementById('candidate-dashboard');
            const logoutCandidateBtn = document.getElementById('logout-candidate-btn');

            // Register Candidate Elements
            const registerCandidateForm = document.getElementById('register-candidate-form');
            const logoPreview = document.getElementById('logo-preview');
            const uploadLogoBtn = document.getElementById('upload-logo-btn');
            const partyLogoUpload = document.getElementById('party-logo-upload');

            // Custom Alert Modal Elements
            const customAlertModal = document.getElementById('custom-alert-modal');
            const alertMessage = document.getElementById('alert-message');
            const alertOkBtn = document.getElementById('alert-ok-btn');

            // --- Feature Toggles and Custom Messages ---
            const IS_VOTING_ENABLED = true; // Set to true to enable voting as requested
            const VOTING_DISABLED_CUSTOM_MESSAGE = "Voting is tomorrow. Please check back tomorrow at 1 pm !";

            const IS_REGISTRATION_ENABLED = true; // Set to true to enable candidate registration
            const REGISTRATION_DISABLED_CUSTOM_MESSAGE = "Voting is going on.";
            // --- End Feature Toggles ---

            // --- Constants & State Variables ---
            const API_BASE_URL = 'https://voting.1987sakshamsingh.workers.dev/api';
            const placeholderImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAQAAADa613fAAAAaElEQVR42u3PQREAAAgDoC2G/Yt62e20IIDz9wYBAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgMDbA3cAAR2gLdJPAAAAAElFTSuQmCC';
            let allCandidates = []; // Stores all fetched candidates for search
            let votes = [];
            let currentVotingId = sessionStorage.getItem('currentVotingId') || null;
            let currentVotingPlayerDetails = JSON.parse(sessionStorage.getItem('currentVotingPlayerDetails')) || null;
            let loggedInCandidate = JSON.parse(sessionStorage.getItem('loggedInCandidate')) || null;
            let isVotingDisabledForUsedId = false;

            // --- API Fetch Functions ---
            async function fetchData(endpoint) {
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`API Error fetching ${endpoint}: ${response.status} - ${errorText}`);
                        showCustomAlert(`Error loading data: ${response.statusText}`);
                        return null;
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Network error fetching ${endpoint}:`, error);
                    showCustomAlert(`Network error: Could not connect to server.`);
                    return null;
                }
            }

            async function postData(endpoint, data) {
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`API Error posting to ${endpoint}: ${response.status} - ${errorText}`);
                        showCustomAlert(`Error: ${errorText || response.statusText}`);
                        return null;
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Network error posting to ${endpoint}:`, error);
                    showCustomAlert(`Network error: Could not connect to server.`);
                    return null;
                }
            }

            // --- Helper Functions ---
            function showCustomAlert(message) {
                alertMessage.textContent = message;
                customAlertModal.classList.add('visible');
            }

            function hideCustomAlert() {
                customAlertModal.classList.remove('visible');
            }

            function getPartyVoteCount(partyName) {
                return votes.filter(vote => vote.party === partyName).length;
            }

            // --- UI Management Functions ---

            /**
             * Shows a specific tab content and activates its button.
             * @param {HTMLElement} tabContentToShow - The content div to display.
             * @param {HTMLElement} tabButtonToActivate - The button to mark as active.
             */
            function showTab(tabContentToShow, tabButtonToActivate) {
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                // Deactivate all tab buttons
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                });

                // Show the selected tab content
                tabContentToShow.classList.remove('hidden');
                // Activate the selected tab button
                tabButtonToActivate.classList.add('active');

                // Perform specific updates for each tab
                if (tabContentToShow === contentVote) {
                    updateVoteSectionUI();
                } else if (tabContentToShow === contentCandidateLogin) {
                    displayCandidateDashboard(); // Show login form or dashboard
                } else if (tabContentToShow === contentRegisterCandidate) {
                    // No specific update needed on tab switch, form is always visible
                }
            }

            /**
             * Updates the UI of the Vote section based on login status and voting ID usage.
             */
            function updateVoteSectionUI() {
                // This function is now only called AFTER a successful initial login

                // Check if voting is generally enabled
                if (!IS_VOTING_ENABLED) {
                    voteSectionDetails.classList.remove('hidden'); // Ensure container is visible for message
                    playerInfoDisplay.classList.add('hidden');
                    realNameInput.classList.add('hidden');
                    contactInfoInput.classList.add('hidden');
                    enteredDetailsDisplay.classList.add('hidden');
                    partyListForVoting.classList.add('hidden');
                    votingDisabledMessage.classList.remove('hidden');
                    votingDisabledMessage.innerHTML = `<p class="text-xl font-semibold">${VOTING_DISABLED_CUSTOM_MESSAGE}</p>`;
                    votingDisabledMessage.classList.remove('bg-red-100', 'border-red-300', 'text-red-700');
                    votingDisabledMessage.classList.add('disabled-message'); // Apply custom style
                    return; // Exit early if voting is disabled
                }

                voteSectionDetails.classList.remove('hidden');

                // Display player info from the validated voting ID
                displayMinecraftName.textContent = currentVotingPlayerDetails.playerName || 'N/A';
                displayGameEdition.textContent = currentVotingPlayerDetails.gameEdition || 'N/A';
                playerInfoDisplay.classList.remove('hidden');

                if (currentVotingPlayerDetails.gameEdition === 'Bedrock') {
                    bedrockHint.classList.remove('hidden');
                } else {
                    bedrockHint.classList.add('hidden');
                }

                // Update entered details display dynamically as user types
                realNameInput.addEventListener('input', updateEnteredDetailsDisplay);
                contactInfoInput.addEventListener('input', updateEnteredDetailsDisplay);
                updateEnteredDetailsDisplay(); // Initial call to set display based on current values


                if (isVotingDisabledForUsedId) {
                    votingDisabledMessage.classList.remove('hidden');
                    votingDisabledMessage.innerHTML = `
                        <p class="text-xl font-semibold">
                            This Voting ID has already been used. You cannot cast another vote.
                        </p>
                        <p class="text-sm mt-2">You can still view live vote counts and candidate information.</p>
                    `;
                    votingDisabledMessage.classList.add('bg-red-100', 'border-red-300', 'text-red-700');
                    votingDisabledMessage.classList.remove('disabled-message'); // Remove custom style if it was applied
                    partyListForVoting.classList.add('hidden');
                } else {
                    votingDisabledMessage.classList.add('hidden');
                    partyListForVoting.classList.remove('hidden');
                    // Ensure search input is visible and party list is displayed
                    partySearchInput.value = ''; // Clear search input on UI update
                    displayPartyList(); // Display all parties initially
                }
            }

            function updateEnteredDetailsDisplay() {
                displayRealName.textContent = `Real Name: ${realNameInput.value}`;
                displayContactInfo.textContent = `Contact: ${contactInfoInput.value}`;
                if (realNameInput.value || contactInfoInput.value) {
                    enteredDetailsDisplay.classList.remove('hidden');
                } else {
                    enteredDetailsDisplay.classList.add('hidden');
                }
            }


            /**
             * Updates and displays the live vote count for all parties.
             */
            async function updateLiveVoteCount() {
                // Fetch latest votes and candidates directly to ensure data consistency
                votes = await fetchData('/votes');
                const latestCandidates = await fetchData('/candidates');

                if (!votes || !latestCandidates) {
                    liveVoteCountDiv.innerHTML = '<p class="text-center text-gray-500">Error loading vote data or candidate data.</p>';
                    return;
                }

                // Update the global allCandidates array with the latest data
                allCandidates = latestCandidates;

                liveVoteCountDiv.innerHTML = '';
                const voteCounts = {};

                // Initialize counts for all known candidates
                allCandidates.forEach(c => voteCounts[c.partyName] = 0);

                votes.forEach(vote => {
                    if (voteCounts.hasOwnProperty(vote.party)) { // Ensure party exists
                        voteCounts[vote.party] = (voteCounts[vote.party] || 0) + 1;
                    }
                });

                const sortedVoteCounts = Object.entries(voteCounts).sort(([, countA], [, countB]) => countB - countA);

                if (sortedVoteCounts.length > 0) {
                    sortedVoteCounts.forEach(([party, count]) => {
                        const partyData = allCandidates.find(c => c.partyName === party);
                        const div = document.createElement('div');
                        div.classList.add('vote-count-item', 'flex', 'items-center', 'p-2', 'bg-gray-50', 'rounded-md', 'shadow-sm', 'text-gray-800');

                        if (partyData) { // Ensure partyData exists before trying to access its properties
                            if (partyData.partyLogo && partyData.partyLogo !== placeholderImage) { // Check if a valid logo exists
                                const logo = document.createElement('img');
                                logo.src = partyData.partyLogo;
                                logo.alt = partyData.partyName;
                                logo.classList.add('party-logo-small');
                                div.appendChild(logo);
                            } else if (partyData.partyChinn) { // Fallback to symbol if no valid logo
                                const symbolSpan = document.createElement('span');
                                symbolSpan.textContent = partyData.partyChinn;
                                symbolSpan.classList.add('text-2xl', 'mr-2');
                                div.appendChild(symbolSpan);
                            }
                        }

                        const text = document.createElement('span');
                        text.textContent = `${party}: ${count} votes`;
                        div.appendChild(text);

                        liveVoteCountDiv.appendChild(div);
                    });
                } else {
                    liveVoteCountDiv.innerHTML = '<p class="text-center text-gray-500">No votes cast yet.</p>';
                    liveVoteCountDiv.classList.add('text-center', 'text-gray-500');
                }
            }

            /**
             * Displays the list of registered parties for voting.
             * @param {Array} [filteredList=null] - Optional array of candidates to display (for search).
             */
            async function displayPartyList(filteredList = null) {
                // If no filtered list is provided, fetch all candidates
                if (filteredList === null) {
                    allCandidates = await fetchData('/candidates'); // Populate allCandidates
                    if (!allCandidates) return;
                    filteredList = allCandidates; // Use all candidates if no filter
                }

                partyListDiv.innerHTML = '';
                if (filteredList.length === 0) {
                    partyListDiv.innerHTML = '<p class="text-center text-gray-500">No parties found matching your search, or no parties registered yet.</p>';
                    partyListDiv.classList.add('text-center', 'text-gray-500');
                    return;
                }

                filteredList.forEach(candidate => {
                    const partyCard = document.createElement('div');
                    // **FIX:** Only add the 'party-card' class. The rest of the styling is in the CSS.
                    partyCard.classList.add('party-card');

                    const partyLogo = document.createElement('img');
                    partyLogo.src = candidate.partyLogo || placeholderImage;
                    partyLogo.alt = candidate.partyName;
                    // Using Tailwind classes here is fine as they don't conflict with the .party-card definition
                    partyLogo.classList.add('w-24', 'h-24', 'object-cover', 'rounded-full', 'mb-4', 'border', 'border-gray-300');

                    const partyName = document.createElement('h3');
                    partyName.textContent = candidate.partyName;
                    partyName.classList.add('text-xl', 'font-semibold', 'mb-2', 'text-gray-800');

                    const partyLeader = document.createElement('p');
                    partyLeader.textContent = `Leader: ${candidate.candidateName}`;
                    partyLeader.classList.add('text-gray-600', 'text-sm');

                    const partyChinn = document.createElement('p');
                    partyChinn.textContent = `Symbol: ${candidate.partyChinn}`;
                    partyChinn.classList.add('text-gray-600', 'text-sm', 'mb-4');

                    const voteButton = document.createElement('button');
                    voteButton.textContent = 'Vote for this Party';
                    voteButton.classList.add('action-button', 'w-full', 'mt-auto'); // Added mt-auto to push button to bottom
                    
                    // Disable button if voting is disabled for this ID or generally
                    if (isVotingDisabledForUsedId || !IS_VOTING_ENABLED) {
                        voteButton.disabled = true;
                        voteButton.textContent = isVotingDisabledForUsedId ? 'Already Voted' : 'Voting Disabled';
                    }

                    voteButton.addEventListener('click', async () => {
                        if (!currentVotingId) {
                            showCustomAlert('Please log in with your Voting ID first.');
                            return;
                        }
                        if (isVotingDisabledForUsedId) {
                            showCustomAlert('This Voting ID has already been used. You cannot cast another vote.');
                            return;
                        }
                        // Check IS_VOTING_ENABLED before allowing vote submission
                        if (!IS_VOTING_ENABLED) {
                            showCustomAlert(VOTING_DISABLED_CUSTOM_MESSAGE);
                            return;
                        }


                        const voteData = {
                            votingId: currentVotingId,
                            party: candidate.partyName,
                            realName: realNameInput.value, // Include optional real name
                            discordInsta: contactInfoInput.value // Include optional contact info
                        };

                        const result = await postData('/submit-vote', voteData);
                        if (result && result.success) {
                            showCustomAlert(`You have successfully voted for ${candidate.partyName}!`);
                            isVotingDisabledForUsedId = true;
                            sessionStorage.setItem('isVotingDisabledForUsedId', 'true');
                            updateVoteSectionUI(); // Re-render UI to disable vote buttons
                            await updateLiveVoteCount();
                        } else {
                            showCustomAlert(result ? result.message : 'Failed to submit vote.');
                        }
                    });

                    partyCard.appendChild(partyLogo);
                    partyCard.appendChild(partyName);
                    partyCard.appendChild(partyLeader);
                    partyCard.appendChild(partyChinn);
                    partyCard.appendChild(voteButton);
                    partyListDiv.appendChild(partyCard);
                });
            }

            /**
             * Handles candidate login.
             */
            async function loginCandidate(partyName, password) {
                allCandidates = await fetchData('/candidates'); // Use allCandidates here
                if (!allCandidates) return;

                // Passwords are stored base64 encoded
                loggedInCandidate = allCandidates.find(c => c.partyName === partyName && c.password === btoa(password));

                if (loggedInCandidate) {
                    sessionStorage.setItem('loggedInCandidate', JSON.stringify(loggedInCandidate));
                    showCustomAlert('Login successful! Welcome to your dashboard.');
                    displayCandidateDashboard();
                } else {
                    showCustomAlert('Invalid Party Name or Password.');
                    loggedInCandidate = null;
                    sessionStorage.removeItem('loggedInCandidate');
                    displayCandidateDashboard();
                }
            }

            /**
             * Handles candidate logout.
             */
            function logoutCandidate() {
                loggedInCandidate = null;
                sessionStorage.removeItem('loggedInCandidate');
                displayCandidateDashboard();
                showCustomAlert('Logged out successfully.');
            }

            /**
             * Displays the candidate's dashboard if logged in, or the login form otherwise.
             */
            async function displayCandidateDashboard() {
                if (loggedInCandidate) {
                    partyManagementLoginSection.classList.add('hidden');
                    candidateDashboard.classList.remove('hidden');
                    await updateLiveVoteCount(); // Ensure votes are fresh for dashboard

                    candidateDashboard.innerHTML = `
                        <h3 class="text-xl font-semibold mb-2 text-gray-800">Welcome, ${loggedInCandidate.candidateName}!</h3>
                        <p class="text-gray-600">Party: ${loggedInCandidate.partyName}</p>
                        <p class="text-gray-600 mb-4">Symbol: ${loggedInCandidate.partyChinn}</p>
                        <img src="${loggedInCandidate.partyLogo}" alt="${loggedInCandidate.partyName}" class="party-logo-large mb-4">
                        <p class="text-lg font-bold text-gray-800">Your party currently has <strong>${getPartyVoteCount(loggedInCandidate.partyName)}</strong> votes.</p>
                        <button id="logout-candidate-btn" class="action-button bg-red-600 hover:bg-red-700 w-full mt-4">Logout</button>
                    `;
                    document.getElementById('logout-candidate-btn').addEventListener('click', logoutCandidate);
                } else {
                    partyManagementLoginSection.classList.remove('hidden');
                    candidateDashboard.classList.add('hidden');
                    partyLoginForm.reset();
                }
            }

            // --- Event Listeners ---

            // Custom Alert OK button
            alertOkBtn.addEventListener('click', hideCustomAlert);

            // Initial Voting ID Login Button
            votingIdLoginBtnInitial.addEventListener('click', async () => {
                const id = votingIdInputInitial.value.trim();
                if (!id) {
                    showCustomAlert('Please enter your Voting ID.');
                    return;
                }

                const result = await postData('/check-voting-id', { votingId: id });

                if (result && result.success && result.valid) {
                    currentVotingId = id;
                    sessionStorage.setItem('currentVotingId', currentVotingId);
                    currentVotingPlayerDetails = {
                        playerName: result.playerName,
                        gameEdition: result.gameEdition
                    };
                    sessionStorage.setItem('currentVotingPlayerDetails', JSON.stringify(currentVotingPlayerDetails));

                    if (result.used) {
                        isVotingDisabledForUsedId = true;
                        sessionStorage.setItem('isVotingDisabledForUsedId', 'true');
                        showCustomAlert('Login successful, but this Voting ID has already been used. You cannot vote again.');
                    } else {
                        isVotingDisabledForUsedId = false;
                        sessionStorage.removeItem('isVotingDisabledForUsedId');
                        showCustomAlert('Login successful! Welcome.');
                    }

                    initialLoginSection.classList.add('hidden');
                    mainAppContainer.classList.remove('hidden');
                    showTab(contentVote, tabVote); // Automatically go to Vote tab
                    await updateLiveVoteCount();
                    // displayPartyList() is called by updateVoteSectionUI()
                } else {
                    showCustomAlert(result ? result.message : 'Invalid Voting ID.');
                }
            });

            // Logout Button (for general app logout)
            document.getElementById('logout-button').addEventListener('click', () => {
                sessionStorage.clear(); // Clear all session data
                currentVotingId = null;
                currentVotingPlayerDetails = null;
                loggedInCandidate = null;
                isVotingDisabledForUsedId = false;

                initialLoginSection.classList.remove('hidden'); // Show initial login
                mainAppContainer.classList.add('hidden'); // Hide main app

                votingIdInputInitial.value = ''; // Clear initial ID input
                partyLoginForm.reset(); // Clear party login form
                registerCandidateForm.reset(); // Clear register form
                logoPreview.src = placeholderImage; // Reset logo preview

                showCustomAlert('Logged out successfully.');
            });


            // Tab Navigation Buttons
            tabVote.addEventListener('click', () => showTab(contentVote, tabVote));
            tabCandidateLogin.addEventListener('click', () => showTab(contentCandidateLogin, tabCandidateLogin));
            tabRegisterCandidate.addEventListener('click', () => showTab(contentRegisterCandidate, tabRegisterCandidate));

            // Party Logo Upload
            uploadLogoBtn.addEventListener('click', () => {
                partyLogoUpload.click();
            });

            partyLogoUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    // Changed MAX_IMAGE_SIZE_MB to MAX_IMAGE_SIZE_KB and updated calculation
                    const MAX_IMAGE_SIZE_KB = 100; // Example size
                    if (file.size > MAX_IMAGE_SIZE_KB * 1024) {
                        showCustomAlert(`Image size should be less than ${MAX_IMAGE_SIZE_KB}KB.`);
                        event.target.value = '';
                        logoPreview.src = placeholderImage;
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        logoPreview.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Register Candidate Form Submission
            registerCandidateForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Check if registration is generally enabled
                if (!IS_REGISTRATION_ENABLED) {
                    showCustomAlert(REGISTRATION_DISABLED_CUSTOM_MESSAGE);
                    return;
                }

                const candidateName = document.getElementById('candidate-name').value;
                const partyName = document.getElementById('party-name-reg').value;
                const partyPassword = document.getElementById('party-password-reg').value;
                const partyChinn = document.getElementById('party-chinn').value;
                const partyLogo = logoPreview.src;

                const newCandidate = {
                    candidateName,
                    partyName,
                    password: btoa(partyPassword), // Base64 encode password for storage
                    partyChinn,
                    partyLogo
                };

                const result = await postData('/register-candidate', newCandidate);

                if (result && result.success) {
                    showCustomAlert('Candidate registered successfully!');
                    registerCandidateForm.reset();
                    logoPreview.src = placeholderImage;
                    // Automatically log in the new candidate
                    await loginCandidate(partyName, partyPassword);
                    await Promise.all([updateLiveVoteCount(), displayPartyList()]);
                } else {
                    showCustomAlert(result ? result.message : 'Failed to register candidate.');
                }
            });

            // Party Login Form Submission
            partyLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const loginPartyName = document.getElementById('login-party-name').value;
                const loginPartyPassword = document.getElementById('login-party-password').value;
                loginCandidate(loginPartyName, loginPartyPassword);
            });

            // Party Search Input Listener
            partySearchInput.addEventListener('input', () => {
                const searchTerm = partySearchInput.value.toLowerCase();
                // If search term is empty, display all candidates
                if (searchTerm === '') {
                    displayPartyList(allCandidates);
                    return;
                }
                // Filter allCandidates, not just the currently displayed ones
                const filteredCandidates = allCandidates.filter(candidate =>
                    candidate.partyName.toLowerCase().includes(searchTerm) ||
                    candidate.candidateName.toLowerCase().includes(searchTerm) ||
                    candidate.partyChinn.toLowerCase().includes(searchTerm)
                );
                displayPartyList(filteredCandidates);
            });

            // --- Initial Setup on Load ---
            // Hide registration tab and content if disabled
            if (!IS_REGISTRATION_ENABLED) {
                tabRegisterCandidate.classList.add('hidden'); // Hide the tab button
                contentRegisterCandidate.innerHTML = `
                    <div class="disabled-message">
                        <p>${REGISTRATION_DISABLED_CUSTOM_MESSAGE}</p>
                    </div>
                `;
            }


            // Determine which screen to show on page load
            if (currentVotingId) {
                // Attempt to retrieve stored voting ID data
                const storedVotingIdData = sessionStorage.getItem('currentVotingPlayerDetails');
                if (storedVotingIdData) {
                    try {
                        currentVotingPlayerDetails = JSON.parse(storedVotingIdData);
                    } catch (e) {
                        console.error("Error parsing stored currentVotingPlayerDetails:", e);
                        sessionStorage.removeItem('currentVotingPlayerDetails'); // Clear invalid data
                        currentVotingId = null; // Force re-login
                    }
                }

                if (currentVotingId && currentVotingPlayerDetails) { // Proceed only if both are valid
                    initialLoginSection.classList.add('hidden');
                    mainAppContainer.classList.remove('hidden');
                    isVotingDisabledForUsedId = sessionStorage.getItem('isVotingDisabledForUsedId') === 'true';
                    updateVoteSectionUI(); // Now currentVotingIdData should be available
                    await Promise.all([updateLiveVoteCount(), displayCandidateDashboard()]);
                    // displayPartyList() is called by updateVoteSectionUI()
                    showTab(contentVote, tabVote);
                } else {
                    // If currentVotingId exists but data is missing/corrupted, force login screen
                    console.warn("Voting ID found but data missing or corrupted. Redirecting to login.");
                    sessionStorage.removeItem('currentVotingId');
                    sessionStorage.removeItem('currentVotingPlayerDetails');
                    sessionStorage.removeItem('isVotingDisabledForUsedId');
                    initialLoginSection.classList.remove('hidden');
                    mainAppContainer.classList.add('hidden');
                    // No specific tab to show here, as it's the initial login screen
                }
            } else if (loggedInCandidate) {
                initialLoginSection.classList.add('hidden');
                mainAppContainer.classList.remove('hidden');
                await Promise.all([updateLiveVoteCount(), displayPartyList(), displayCandidateDashboard()]);
                showTab(contentCandidateLogin, tabCandidateLogin);
            } else {
                initialLoginSection.classList.remove('hidden');
                mainAppContainer.classList.add('hidden');
                // No specific tab to show here, as it's the initial login screen
            }
        });
    </script>
</body>
</html>
