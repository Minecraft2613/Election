<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Election</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the app */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #e0f2f7, #c1e4ed); /* Light blue gradient */
            color: #374151; /* Dark gray text */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .initial-login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(to bottom right, #e0f2f7, #c1e4ed); /* Match body background */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 999;
        }
        .app-container {
            background-color: #ffffff; /* White background for the main app */
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Soft shadow */
            padding: 2rem;
            max-width: 900px; /* Max width for larger screens */
            width: 100%;
            display: flex;
            flex-direction: column;
            min-height: 80vh; /* Ensure it takes up a good portion of the viewport */
        }
        .tab-button {
            @apply px-4 py-2 rounded-t-lg font-medium text-gray-600 hover:bg-gray-100 transition duration-200 ease-in-out;
        }
        .tab-button.active {
            @apply bg-white text-blue-600 border-b-2 border-blue-600;
        }
        .tab-content {
            @apply p-6 bg-white rounded-b-lg shadow-inner flex-grow;
        }
        .hidden {
            display: none !important;
        }
        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 80%;
            max-width: 500px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Initial Login/Registration Section -->
    <div id="initial-login-section" class="initial-login-container w-full max-w-md p-8 bg-white rounded-xl shadow-lg">
        <h2 class="text-3xl font-bold text-center text-blue-700 mb-8">Minecraft Election</h2>

        <!-- Login Tabs -->
        <div class="flex justify-center mb-6 border-b border-gray-200">
            <button id="tab-login-voting-id" class="tab-button active">Vote</button>
            <button id="tab-login-party" class="tab-button">Party Login</button>
            <button id="tab-register-party" class="tab-button">Register Party</button>
        </div>

        <!-- Content for Voting ID Login -->
        <div id="content-login-voting-id" class="tab-content">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Enter Your Voting ID</h3>
            <form id="voting-id-login-form" class="space-y-4">
                <div>
                    <label for="voting-id" class="block text-sm font-medium text-gray-700 mb-1">Voting ID</label>
                    <input type="text" id="voting-id" name="votingId" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out font-semibold text-lg">
                    Login to Vote
                </button>
                <p id="login-message" class="text-center text-sm mt-4 hidden"></p>
            </form>
        </div>

        <!-- Content for Party Login -->
        <div id="content-login-party" class="tab-content hidden">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Party Login</h3>
            <form id="party-login-form" class="space-y-4">
                <div>
                    <label for="login-party-name" class="block text-sm font-medium text-gray-700 mb-1">Party Name</label>
                    <input type="text" id="login-party-name" name="partyName" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg">
                </div>
                <div>
                    <label for="login-party-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-party-password" name="password" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out font-semibold text-lg">
                    Login as Party
                </button>
                <p id="party-login-message" class="text-center text-sm mt-4 hidden"></p>
            </form>
        </div>

        <!-- Content for Register Party -->
        <div id="content-register-party" class="tab-content hidden">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Register New Party</h3>
            <form id="register-party-form" class="space-y-4">
                <div>
                    <label for="register-party-name" class="block text-sm font-medium text-gray-700 mb-1">Party Name</label>
                    <input type="text" id="register-party-name" name="partyName" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg">
                </div>
                <div>
                    <label for="register-candidate-name" class="block text-sm font-medium text-gray-700 mb-1">Candidate Name (Leader)</label>
                    <input type="text" id="register-candidate-name" name="candidateName" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg">
                </div>
                <div>
                    <label for="register-party-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="register-party-password" name="password" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg">
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300 ease-in-out font-semibold text-lg">
                    Register Party
                </button>
                <p id="register-message" class="text-center text-sm mt-4 hidden"></p>
            </form>
        </div>
    </div>

    <!-- Main App Container (Hidden by default) -->
    <div id="main-app-container" class="app-container hidden">
        <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-blue-700">Minecraft Election</h1>
            <button id="logout-button" class="bg-red-500 text-white py-2 px-4 rounded-lg shadow hover:bg-red-600 transition duration-300 ease-in-out font-semibold">Logout</button>
        </div>

        <!-- Main Tabs -->
        <div class="flex mb-6 border-b border-gray-200">
            <button id="tab-vote" class="tab-button active">Vote</button>
            <button id="tab-live-results" class="tab-button">Live Results</button>
            <button id="tab-candidate-dashboard" class="tab-button">Candidate Dashboard</button>
        </div>

        <!-- Content for Vote Section -->
        <div id="content-vote" class="tab-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Cast Your Vote</h2>

            <!-- Player Info Display -->
            <div class="mb-6 bg-blue-100 p-4 rounded-lg shadow-inner">
                <p class="text-lg font-semibold text-blue-800 mb-2">Your Voting Details:</p>
                <p class="text-md"><span class="font-medium">Voting ID:</span> <span id="voting-id-display" class="font-bold text-blue-700"></span></p>
                <p class="text-md"><span class="font-medium">Minecraft Name:</span> <span id="player-name-display" class="font-bold text-blue-700"></span></p>
                <p class="text-md"><span class="font-medium">Game Edition:</span> <span id="game-edition-display" class="font-bold text-blue-700"></span></p>
                <p class="text-sm text-blue-600 mt-2">
                    <span id="bedrock-hint" class="hidden">For Bedrock Edition, your username might include a dot (e.g., `Player.Name`). Please ensure it matches your in-game name.</span>
                </p>
            </div>

            <!-- New Input Fields for Real Name and Contact Info -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold mb-3 text-gray-700">Optional Details:</h3>
                <div class="mb-4">
                    <label for="real-name-input" class="block text-sm font-medium text-gray-700 mb-1">Your Real Name (Optional):</label>
                    <input type="text" id="real-name-input" placeholder="e.g., John Doe" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="contact-info-input" class="block text-sm font-medium text-gray-700 mb-1">Discord/WhatsApp/Instagram (Optional):</label>
                    <input type="text" id="contact-info-input" placeholder="e.g., @yourdiscord, +1234567890" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div id="entered-details-display" class="mt-4 p-3 bg-white border border-gray-200 rounded-md hidden">
                    <p class="text-sm font-medium text-gray-600">Entered Details:</p>
                    <p id="display-real-name" class="text-sm text-gray-800"></p>
                    <p id="display-contact-info" class="text-sm text-gray-800"></p>
                </div>
            </div>

            <!-- Party List Display -->
            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Select a Party to Vote For:</h3>
                <div id="party-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Party items will be dynamically loaded here -->
                </div>
            </div>

            <!-- Submit Vote Button and Message -->
            <button id="submit-vote-button" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out font-semibold text-lg">Submit Vote</button>
            <p id="vote-message" class="text-center text-sm mt-4 hidden"></p>
        </div>

        <!-- Content for Live Results Section -->
        <div id="content-live-results" class="tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Live Election Results</h2>
            <div id="live-vote-count" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Live vote counts will be displayed here -->
            </div>
        </div>

        <!-- Content for Candidate Dashboard Section -->
        <div id="content-candidate-dashboard" class="tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Candidate Dashboard</h2>
            <p id="dashboard-message" class="text-gray-600 mb-4">Login as a party to view your specific dashboard.</p>
            <div id="candidate-specific-data" class="hidden">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Your Party's Votes:</h3>
                <p class="text-lg text-gray-700 mb-4">Total Votes for <span id="dashboard-party-name" class="font-bold"></span>: <span id="dashboard-vote-count" class="font-bold text-blue-600"></span></p>
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Recent Votes:</h3>
                <ul id="recent-votes-list" class="list-disc list-inside bg-gray-50 p-4 rounded-lg shadow-inner">
                    <!-- Recent votes for the logged-in candidate's party will be listed here -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Candidate Details Modal -->
    <div id="candidate-details-modal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-party-name" class="text-2xl font-bold text-gray-900"></h3>
                <button id="close-modal-button" class="close-button">&times;</button>
            </div>
            <p class="text-lg text-gray-700 mb-2"><span class="font-semibold">Leader:</span> <span id="modal-candidate-name"></span></p>
            <p class="text-sm text-gray-600 mt-4">This is where more detailed information about the candidate and their party would go (e.g., manifesto, vision, etc., if added to `candidates.json`).</p>
        </div>
    </div>

    <script>
        // API Endpoint for your Cloudflare Worker
        const API_BASE_URL = 'https://voting.1987sakshamsingh.workers.dev/api';

        // Global variables to store current state
        let currentVotingId = sessionStorage.getItem('currentVotingId');
        let currentVotingIdData = null; // Will be populated from sessionStorage or API
        let loggedInCandidate = sessionStorage.getItem('loggedInCandidate');
        let isVotingDisabledForUsedId = sessionStorage.getItem('isVotingDisabledForUsedId') === 'true';

        // DOM Elements
        const initialLoginSection = document.getElementById('initial-login-section');
        const mainAppContainer = document.getElementById('main-app-container');

        // Login Tabs
        const tabLoginVotingId = document.getElementById('tab-login-voting-id');
        const tabLoginParty = document.getElementById('tab-login-party');
        const tabRegisterParty = document.getElementById('tab-register-party');

        const contentLoginVotingId = document.getElementById('content-login-voting-id');
        const contentLoginParty = document.getElementById('content-login-party');
        const contentRegisterParty = document.getElementById('content-register-party');

        // Main Tabs
        const tabVote = document.getElementById('tab-vote');
        const tabLiveResults = document.getElementById('tab-live-results');
        const tabCandidateDashboard = document.getElementById('tab-candidate-dashboard');

        const contentVote = document.getElementById('content-vote');
        const contentLiveResults = document.getElementById('content-live-results');
        const contentCandidateDashboard = document.getElementById('content-candidate-dashboard');

        // Forms
        const votingIdLoginForm = document.getElementById('voting-id-login-form');
        const partyLoginForm = document.getElementById('party-login-form');
        const registerPartyForm = document.getElementById('register-party-form');

        // Buttons
        const logoutButton = document.getElementById('logout-button');

        // --- Helper Functions ---

        /**
         * Shows a specific tab content and activates its button.
         * @param {HTMLElement} contentElement - The content div to show.
         * @param {HTMLElement} tabButtonElement - The tab button to activate.
         */
        function showTab(contentElement, tabButtonElement) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            // Deactivate all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));

            // Show the selected content and activate the selected button
            contentElement.classList.remove('hidden');
            tabButtonElement.classList.add('active');
        }

        /**
         * Displays a message on the UI.
         * @param {string} elementId - The ID of the paragraph element to display the message.
         * @param {string} message - The message text.
         * @param {'success'|'error'|'info'} type - Type of message for styling.
         */
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.classList.remove('hidden', 'text-green-500', 'text-red-500', 'text-blue-500');
                if (type === 'success') {
                    element.classList.add('text-green-500');
                } else if (type === 'error') {
                    element.classList.add('text-red-500');
                } else {
                    element.classList.add('text-blue-500');
                }
            }
        }

        /**
         * Makes a POST request to the API.
         * @param {string} path - The API endpoint path (e.g., '/check-voting-id').
         * @param {object} data - The data to send in the request body.
         * @returns {Promise<object>} - The JSON response from the API.
         */
        async function postData(path, data) {
            try {
                const response = await fetch(`${API_BASE_URL}${path}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error(`Network error posting to ${path}:`, error);
                throw error;
            }
        }

        /**
         * Makes a GET request to the API.
         * @param {string} path - The API endpoint path (e.g., '/candidates').
         * @returns {Promise<object>} - The JSON response from the API.
         */
        async function fetchData(path) {
            try {
                const response = await fetch(`${API_BASE_URL}${path}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Network error fetching from ${path}:`, error);
                throw error;
            }
        }

        // --- Core Application Logic ---

        /**
         * Handles voting ID login.
         * @param {string} votingId - The voting ID entered by the user.
         */
        async function loginVotingId(votingId) {
            try {
                const result = await postData('/check-voting-id', { votingId });

                if (result.success && result.valid) {
                    currentVotingId = votingId;
                    currentVotingIdData = { // Store the full object
                        id: votingId,
                        playerName: result.playerName,
                        gameEdition: result.gameEdition
                    };
                    sessionStorage.setItem('currentVotingId', votingId);
                    sessionStorage.setItem('currentVotingIdData', JSON.stringify(currentVotingIdData)); // Store as JSON string
                    sessionStorage.setItem('isVotingDisabledForUsedId', result.used);
                    isVotingDisabledForUsedId = result.used;

                    showMessage('login-message', result.message, 'success');
                    initialLoginSection.classList.add('hidden');
                    mainAppContainer.classList.remove('hidden');
                    updateVoteSectionUI(); // Call after data is set
                    await Promise.all([updateLiveVoteCount(), displayPartyList(), displayCandidateDashboard()]);
                    showTab(contentVote, tabVote);
                } else {
                    showMessage('login-message', result.message, 'error');
                }
            } catch (error) {
                console.error('Error checking voting ID:', error);
                showMessage('login-message', `Network error checking ID: ${error.message}`, 'error');
            }
        }

        /**
         * Handles party login.
         * @param {string} partyName - The party name.
         * @param {string} password - The party password.
         */
        async function loginCandidate(partyName, password) {
            try {
                const candidates = await fetchData('/candidates');
                const candidate = candidates.find(c => c.partyName === partyName && c.password === password);

                if (candidate) {
                    loggedInCandidate = partyName;
                    sessionStorage.setItem('loggedInCandidate', partyName);
                    showMessage('party-login-message', 'Logged in as party successfully!', 'success');
                    initialLoginSection.classList.add('hidden');
                    mainAppContainer.classList.remove('hidden');
                    await Promise.all([updateLiveVoteCount(), displayPartyList(), displayCandidateDashboard()]);
                    showTab(contentCandidateDashboard, tabCandidateDashboard);
                } else {
                    showMessage('party-login-message', 'Invalid party name or password.', 'error');
                }
            } catch (error) {
                console.error('Error logging in party:', error);
                showMessage('party-login-message', `Network error logging in: ${error.message}`, 'error');
            }
        }

        /**
         * Handles party registration.
         * @param {object} newCandidate - The new candidate data.
         */
        async function registerParty(newCandidate) {
            try {
                const result = await postData('/register-candidate', newCandidate);
                if (result.success) {
                    showMessage('register-message', result.message, 'success');
                    registerPartyForm.reset(); // Clear form on success
                    // Automatically log in the new candidate
                    await loginCandidate(newCandidate.partyName, newCandidate.password);
                } else {
                    showMessage('register-message', result.message, 'error');
                }
            } catch (error) {
                console.error('Error registering party:', error);
                showMessage('register-message', `Network error registering: ${error.message}`, 'error');
            }
        }

        /**
         * Updates the UI for the vote section based on current voting ID data.
         */
        function updateVoteSectionUI() {
            const votingIdDisplay = document.getElementById('voting-id-display');
            const playerNameDisplay = document.getElementById('player-name-display');
            const gameEditionDisplay = document.getElementById('game-edition-display');
            const voteButton = document.getElementById('submit-vote-button');
            const voteMessage = document.getElementById('vote-message');
            const bedrockHint = document.getElementById('bedrock-hint');

            const realNameInput = document.getElementById('real-name-input');
            const contactInfoInput = document.getElementById('contact-info-input');
            const enteredDetailsDisplay = document.getElementById('entered-details-display');
            const displayRealName = document.getElementById('display-real-name');
            const displayContactInfo = document.getElementById('display-contact-info');

            if (currentVotingIdData) {
                votingIdDisplay.textContent = currentVotingIdData.id;
                gameEditionDisplay.textContent = currentVotingIdData.gameEdition;
                playerNameDisplay.textContent = currentVotingIdData.playerName; // This should now be safe

                if (currentVotingIdData.gameEdition === 'Bedrock') {
                    bedrockHint.classList.remove('hidden');
                } else {
                    bedrockHint.classList.add('hidden');
                }

                // Update entered details display dynamically as user types
                realNameInput.addEventListener('input', () => {
                    displayRealName.textContent = `Real Name: ${realNameInput.value}`;
                    if (realNameInput.value || contactInfoInput.value) {
                        enteredDetailsDisplay.classList.remove('hidden');
                    } else {
                        enteredDetailsDisplay.classList.add('hidden');
                    }
                });
                contactInfoInput.addEventListener('input', () => {
                    displayContactInfo.textContent = `Contact: ${contactInfoInput.value}`;
                    if (realNameInput.value || contactInfoInput.value) {
                        enteredDetailsDisplay.classList.remove('hidden');
                    } else {
                        enteredDetailsDisplay.classList.add('hidden');
                    }
                });

                // Initial display of entered details if values are pre-filled (e.g., after a refresh)
                displayRealName.textContent = `Real Name: ${realNameInput.value}`;
                displayContactInfo.textContent = `Contact: ${contactInfoInput.value}`;
                if (realNameInput.value || contactInfoInput.value) {
                    enteredDetailsDisplay.classList.remove('hidden');
                } else {
                    enteredDetailsDisplay.classList.add('hidden');
                }


                if (isVotingDisabledForUsedId) {
                    voteButton.disabled = true;
                    voteButton.textContent = 'Already Voted';
                    voteButton.classList.add('opacity-50', 'cursor-not-allowed');
                    voteMessage.textContent = 'You have already used this Voting ID to cast a vote.';
                    voteMessage.classList.remove('hidden');
                } else {
                    voteButton.disabled = false;
                    voteButton.textContent = 'Submit Vote';
                    voteButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    voteMessage.classList.add('hidden');
                }
            } else {
                console.error("currentVotingIdData is null. Cannot update vote section UI.");
                votingIdDisplay.textContent = 'N/A';
                playerNameDisplay.textContent = 'N/A';
                gameEditionDisplay.textContent = 'N/A';
                voteButton.disabled = true;
                voteButton.textContent = 'Error';
                voteMessage.textContent = 'Error loading voting ID data. Please try logging in again.';
                voteMessage.classList.remove('hidden');
                bedrockHint.classList.add('hidden'); // Hide hint on error
                enteredDetailsDisplay.classList.add('hidden'); // Hide details on error
            }
        }

        /**
         * Submits a vote for a given party.
         * @param {string} party - The name of the party to vote for.
         */
        async function submitVote(party) {
            if (!currentVotingId || !currentVotingIdData) {
                showMessage('vote-message', 'Please log in with a valid Voting ID first.', 'error');
                return;
            }

            const realName = document.getElementById('real-name-input').value;
            const discordInsta = document.getElementById('contact-info-input').value;

            try {
                const result = await postData('/submit-vote', {
                    votingId: currentVotingId,
                    party: party,
                    realName: realName, // Include real name
                    discordInsta: discordInsta // Include contact info
                });

                if (result.success) {
                    showMessage('vote-message', result.message, 'success');
                    isVotingDisabledForUsedId = true; // Mark as used immediately
                    sessionStorage.setItem('isVotingDisabledForUsedId', 'true');
                    updateVoteSectionUI(); // Update UI to show "Already Voted"
                    await updateLiveVoteCount(); // Refresh vote counts
                } else {
                    showMessage('vote-message', result.message, 'error');
                }
            } catch (error) {
                console.error('Error submitting vote:', error);
                showMessage('vote-message', `Network error submitting vote: ${error.message}`, 'error');
            }
        }

        /**
         * Updates and displays the live vote counts for all parties.
         */
        async function updateLiveVoteCount() {
            const liveVoteCountDiv = document.getElementById('live-vote-count');
            liveVoteCountDiv.innerHTML = '<p class="text-center text-gray-500">Loading live results...</p>';

            try {
                const votes = await fetchData('/votes');
                const candidates = await fetchData('/candidates');

                const voteCounts = {};
                candidates.forEach(c => voteCounts[c.partyName] = 0); // Initialize counts for all parties

                votes.forEach(vote => {
                    if (voteCounts.hasOwnProperty(vote.party)) {
                        voteCounts[vote.party]++;
                    }
                });

                liveVoteCountDiv.innerHTML = ''; // Clear loading message

                if (Object.keys(voteCounts).length > 0) {
                    for (const partyName in voteCounts) {
                        const partyResult = document.createElement('div');
                        partyResult.className = 'bg-white p-4 rounded-lg shadow-md flex items-center justify-between';
                        partyResult.innerHTML = `
                            <span class="text-lg font-semibold text-gray-800">${partyName}:</span>
                            <span class="text-2xl font-bold text-blue-600">${voteCounts[partyName]}</span>
                        `;
                        liveVoteCountDiv.appendChild(partyResult);
                    }
                } else {
                    liveVoteCountDiv.innerHTML = '<p class="text-center text-gray-500">No votes cast yet.</p>';
                }
            } catch (error) {
                console.error('Error updating live vote count:', error);
                liveVoteCountDiv.innerHTML = '<p class="text-center text-red-500">Failed to load live results. Please try again later.</p>';
            }
        }

        /**
         * Displays the list of parties available for voting.
         */
        async function displayPartyList() {
            const partyListDiv = document.getElementById('party-list');
            partyListDiv.innerHTML = '<p class="text-center text-gray-500">Loading parties...</p>';

            try {
                const candidates = await fetchData('/candidates');
                partyListDiv.innerHTML = ''; // Clear loading message

                if (candidates && candidates.length > 0) {
                    candidates.forEach(candidate => {
                        const partyItem = document.createElement('div');
                        partyItem.className = 'bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 ease-in-out flex flex-col items-center text-center';
                        partyItem.innerHTML = `
                            <div class="w-24 h-24 mb-4 rounded-full bg-blue-200 flex items-center justify-center text-4xl font-bold text-blue-800 border-4 border-blue-400">
                                ${candidate.partyName.charAt(0).toUpperCase()}
                            </div>
                            <h4 class="text-xl font-bold text-gray-900 mb-1">${candidate.partyName}</h4>
                            <p class="text-md text-gray-700 mb-4">Leader: ${candidate.candidateName}</p>
                            <button class="vote-button bg-green-500 text-white py-2 px-4 rounded-full shadow-md hover:bg-green-600 transition duration-300 ease-in-out font-semibold text-sm w-full mb-2" data-party="${candidate.partyName}">Vote for ${candidate.partyName}</button>
                            <button class="details-button bg-gray-300 text-gray-800 py-2 px-4 rounded-full shadow-md hover:bg-gray-400 transition duration-300 ease-in-out font-semibold text-sm w-full" data-party-details='${JSON.stringify(candidate)}'>Details</button>
                        `;
                        partyListDiv.appendChild(partyItem);
                    });

                    // Add event listeners for vote buttons
                    document.querySelectorAll('.vote-button').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const party = e.target.dataset.party;
                            submitVote(party);
                        });
                    });

                    // Add event listeners for details buttons
                    document.querySelectorAll('.details-button').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const candidateDetails = JSON.parse(e.target.dataset.partyDetails);
                            showCandidateDetailsModal(candidateDetails);
                        });
                    });

                } else {
                    partyListDiv.innerHTML = '<p class="text-center text-gray-500">No parties registered yet.</p>';
                }
            } catch (error) {
                console.error('Error fetching candidates:', error);
                partyListDiv.innerHTML = '<p class="text-center text-red-500">Failed to load parties. Please try again later.</p>';
            }
        }

        /**
         * Displays the candidate-specific dashboard if a party is logged in.
         */
        async function displayCandidateDashboard() {
            const dashboardMessage = document.getElementById('dashboard-message');
            const candidateSpecificData = document.getElementById('candidate-specific-data');
            const dashboardPartyName = document.getElementById('dashboard-party-name');
            const dashboardVoteCount = document.getElementById('dashboard-vote-count');
            const recentVotesList = document.getElementById('recent-votes-list');

            if (loggedInCandidate) {
                dashboardMessage.classList.add('hidden');
                candidateSpecificData.classList.remove('hidden');
                dashboardPartyName.textContent = loggedInCandidate;

                recentVotesList.innerHTML = '<p class="text-gray-500">Loading votes...</p>';

                try {
                    const allVotes = await fetchData('/votes');
                    const myPartyVotes = allVotes.filter(vote => vote.party === loggedInCandidate);

                    dashboardVoteCount.textContent = myPartyVotes.length;
                    recentVotesList.innerHTML = ''; // Clear loading message

                    if (myPartyVotes.length > 0) {
                        // Display last 5 votes
                        myPartyVotes.slice(-5).reverse().forEach(vote => {
                            const listItem = document.createElement('li');
                            listItem.className = 'mb-1 text-gray-800';
                            listItem.textContent = `ID: ${vote.votingId} (Minecraft: ${vote.minecraftName}, Edition: ${vote.gameEdition}) - ${new Date(vote.timestamp).toLocaleString()}`;
                            recentVotesList.appendChild(listItem);
                        });
                    } else {
                        recentVotesList.innerHTML = '<p class="text-gray-500">No votes received yet.</p>';
                    }

                } catch (error) {
                    console.error('Error fetching candidate dashboard data:', error);
                    recentVotesList.innerHTML = '<p class="text-red-500">Failed to load dashboard data.</p>';
                }

            } else {
                dashboardMessage.classList.remove('hidden');
                candidateSpecificData.classList.add('hidden');
            }
        }

        // Function to show candidate details modal
        function showCandidateDetailsModal(candidate) {
            document.getElementById('modal-party-name').textContent = candidate.partyName;
            document.getElementById('modal-candidate-name').textContent = candidate.candidateName;
            // You can add more details here if your candidates.json has additional fields
            document.getElementById('candidate-details-modal').classList.remove('hidden');
            document.getElementById('candidate-details-modal').style.display = 'flex'; // Ensure flex for centering
        }

        // Close modal event listener
        document.getElementById('close-modal-button').addEventListener('click', () => {
            document.getElementById('candidate-details-modal').classList.add('hidden');
            document.getElementById('candidate-details-modal').style.display = 'none';
        });


        // --- Event Listeners ---

        // Tab Navigation
        tabLoginVotingId.addEventListener('click', () => showTab(contentLoginVotingId, tabLoginVotingId));
        tabLoginParty.addEventListener('click', () => showTab(contentLoginParty, tabLoginParty));
        tabRegisterParty.addEventListener('click', () => showTab(contentRegisterParty, tabRegisterParty));

        tabVote.addEventListener('click', async () => {
            showTab(contentVote, tabVote);
            await Promise.all([updateLiveVoteCount(), displayPartyList(), displayCandidateDashboard()]); // Refresh data on tab switch
        });
        tabLiveResults.addEventListener('click', async () => {
            showTab(contentLiveResults, tabLiveResults);
            await Promise.all([updateLiveVoteCount(), displayPartyList(), displayCandidateDashboard()]); // Refresh data on tab switch
        });
        tabCandidateDashboard.addEventListener('click', async () => {
            showTab(contentCandidateDashboard, tabCandidateDashboard);
            await Promise.all([updateLiveVoteCount(), displayPartyList(), displayCandidateDashboard()]); // Refresh data on tab switch
        });


        // Logout Button
        logoutButton.addEventListener('click', () => {
            sessionStorage.clear(); // Clear all session data
            currentVotingId = null;
            currentVotingIdData = null;
            loggedInCandidate = null;
            isVotingDisabledForUsedId = false;
            initialLoginSection.classList.remove('hidden');
            mainAppContainer.classList.add('hidden');
            showMessage('login-message', 'Logged out successfully.', 'info');
            votingIdLoginForm.reset();
            partyLoginForm.reset();
            registerPartyForm.reset();
            showTab(contentLoginVotingId, tabLoginVotingId); // Go back to voting ID login tab
        });

        // Form Submissions
        votingIdLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const votingId = document.getElementById('voting-id').value;
            loginVotingId(votingId);
        });

        partyLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const loginPartyName = document.getElementById('login-party-name').value;
            const loginPartyPassword = document.getElementById('login-party-password').value;
            loginCandidate(loginPartyName, loginPartyPassword);
        });

        registerPartyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const partyName = document.getElementById('register-party-name').value;
            const candidateName = document.getElementById('register-candidate-name').value;
            const password = document.getElementById('register-party-password').value;
            registerParty({ partyName, candidateName, password });
        });


        // --- Initial Setup on Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Determine which screen to show on page load
            if (currentVotingId) {
                // Attempt to retrieve stored voting ID data
                const storedVotingIdData = sessionStorage.getItem('currentVotingIdData');
                if (storedVotingIdData) {
                    try {
                        currentVotingIdData = JSON.parse(storedVotingIdData);
                    } catch (e) {
                        console.error("Error parsing stored currentVotingIdData:", e);
                        sessionStorage.removeItem('currentVotingIdData'); // Clear invalid data
                        currentVotingId = null; // Force re-login
                    }
                }

                if (currentVotingId && currentVotingIdData) { // Proceed only if both are valid
                    initialLoginSection.classList.add('hidden');
                    mainAppContainer.classList.remove('hidden');
                    isVotingDisabledForUsedId = sessionStorage.getItem('isVotingDisabledForUsedId') === 'true';
                    updateVoteSectionUI(); // Now currentVotingIdData should be available
                    await Promise.all([updateLiveVoteCount(), displayPartyList(), displayCandidateDashboard()]);
                    showTab(contentVote, tabVote);
                } else {
                    // If currentVotingId exists but data is missing/corrupted, force login screen
                    console.warn("Voting ID found but data missing or corrupted. Redirecting to login.");
                    sessionStorage.removeItem('currentVotingId');
                    sessionStorage.removeItem('currentVotingIdData');
                    sessionStorage.removeItem('isVotingDisabledForUsedId');
                    initialLoginSection.classList.remove('hidden');
                    mainAppContainer.classList.add('hidden');
                    showTab(contentLoginVotingId, tabLoginVotingId); // Ensure correct tab is shown
                }
            } else if (loggedInCandidate) {
                initialLoginSection.classList.add('hidden');
                mainAppContainer.classList.remove('hidden');
                await Promise.all([updateLiveVoteCount(), displayPartyList(), displayCandidateDashboard()]);
                showTab(contentCandidateDashboard, tabCandidateDashboard);
            } else {
                initialLoginSection.classList.remove('hidden');
                mainAppContainer.classList.add('hidden');
                showTab(contentLoginVotingId, tabLoginVotingId); // Default to voting ID login
            }
        });
    </script>
</body>
</html>
