\<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Voting App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #374151; /* Dark gray text */
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 1rem;
        }
        .section-header {
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .section-header:hover {
            background-color: #e5e7eb; /* Lighter gray on hover */
        }
        .section-content.collapsed {
            display: none;
        }
        .party-logo-small {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid #d1d5db; /* Light border for logos */
        }
        .party-logo-large {
            max-width: 150px;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #d1d5db;
        }
        /* Custom Alert Modal Styles */
        .custom-alert-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .custom-alert-modal.visible {
            display: flex;
        }
        .custom-alert-content {
            background-color: #ffffff;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 400px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Layout for sections */
        .container.two-column-active {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        .container.two-column-active > section {
            flex: 1; /* Distribute space */
            margin-bottom: 1rem; /* Space between sections on wrap */
        }
        .container.two-column-active > .expanded-main-section {
            flex: 2; /* Main section takes more space */
            min-width: 60%; /* Ensure it doesn't get too small */
        }
        .container.two-column-active > .sidebar-section {
            flex: 1; /* Sidebar sections take less space */
            min-width: 30%; /* Ensure they don't get too small */
        }

        /* Responsive adjustments */
        @media (min-width: 1024px) { /* Large screens */
            .container.two-column-active {
                flex-direction: row; /* Horizontal layout */
            }
            .container.two-column-active > .expanded-main-section {
                width: 66%; /* Two-thirds width */
                min-width: auto;
            }
            .container.two-column-active > .sidebar-section {
                width: 33%; /* One-third width */
                min-width: auto;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="initial-login-section" class="min-h-screen flex items-center justify-center bg-blue-600 text-white p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center max-w-sm w-full">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Welcome to the Minecraft Voting App</h2>
            <p class="mb-4 text-gray-700">Please enter your unique Voting ID to proceed.</p>
            <input type="text" id="voting-id-input" placeholder="Enter Voting ID" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
            <button id="voting-id-login-btn" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 rounded-lg shadow-md">Login</button>
        </div>
    </div>

    <div id="main-app-container" class="hidden container mx-auto mt-8 flex flex-col lg:flex-row gap-4">
        <!-- Vote Section -->
        <section id="vote-section" class="bg-white p-6 rounded-lg shadow-md flex-1">
            <div class="section-header flex justify-between items-center mb-4 p-2 rounded-md">
                <h2 class="text-2xl font-semibold text-gray-800">Vote</h2>
                <button class="toggle-btn text-blue-500 hover:text-blue-700 font-bold">^</button>
            </div>
            <div class="section-content">
                <div id="player-details-form-container" class="mb-6">
                    <h3 class="text-xl font-medium mb-4">Enter Your Player Details</h3>
                    <form id="player-details-form" class="space-y-4">
                        <div>
                            <label for="edition" class="block text-sm font-medium text-gray-700">Minecraft Edition:</label>
                            <select id="edition" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="java">Java Edition</option>
                                <option value="bedrock">Bedrock Edition</option>
                            </select>
                        </div>
                        <div id="java-name-field">
                            <label for="java-name" class="block text-sm font-medium text-gray-700">Minecraft Java Name:</label>
                            <input type="text" id="java-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div id="bedrock-name-field" style="display: none;">
                            <label for="bedrock-name" class="block text-sm font-medium text-gray-700">Minecraft Bedrock Name:</label>
                            <input type="text" id="bedrock-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="real-name" class="block text-sm font-medium text-gray-700">Your Real Name (Optional):</label>
                            <input type="text" id="real-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="discord-insta" class="block text-sm font-medium text-gray-700">Discord/Instagram (Optional):</label>
                            <input type="text" id="discord-insta" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button type="button" id="next-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 rounded-lg shadow-md">Next</button>
                    </form>
                </div>

                <div id="player-details-display" class="hidden mb-6 p-4 border border-gray-200 rounded-md bg-gray-50">
                    <h3 class="text-xl font-medium mb-2">Your Details:</h3>
                    <p><strong>Minecraft Name:</strong> <span id="display-minecraft-name"></span></p>
                    <p><strong>Edition:</strong> <span id="display-edition"></span></p>
                    <p><strong>Real Name:</strong> <span id="display-real-name"></span></p>
                    <p><strong>Discord/Instagram:</strong> <span id="display-discord-insta"></span></p>
                    <button id="change-player-details-btn" class="mt-4 bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 rounded-lg shadow-md">Change Details</button>
                </div>

                <div id="party-list-for-voting" class="hidden mt-6">
                    <h3 class="text-xl font-medium mb-4">Cast Your Vote!</h3>
                    <div id="party-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Party cards will be loaded here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Live Vote Count Section -->
        <section id="live-vote-section" class="bg-white p-6 rounded-lg shadow-md flex-1 sidebar-section">
            <div class="section-header flex justify-between items-center mb-4 p-2 rounded-md">
                <h2 class="text-2xl font-semibold text-gray-800">Live Vote Count</h2>
                <button class="toggle-btn text-blue-500 hover:text-blue-700 font-bold">^</button>
            </div>
            <div class="section-content collapsed">
                <div id="live-vote-count" class="space-y-3">
                    <!-- Live vote counts will be displayed here -->
                </div>
            </div>
        </section>

        <!-- Candidate Management Section -->
        <section id="candidate-management-section" class="bg-white p-6 rounded-lg shadow-md flex-1 sidebar-section">
            <div class="section-header flex justify-between items-center mb-4 p-2 rounded-md">
                <h2 class="text-2xl font-semibold text-gray-800">Candidate Management</h2>
                <button class="toggle-btn text-blue-500 hover:text-blue-700 font-bold">^</button>
            </div>
            <div class="section-content collapsed">
                <div id="party-management-login-section">
                    <h3 class="text-xl font-medium mb-4">Candidate Login</h3>
                    <form id="party-login-form" class="space-y-4">
                        <div>
                            <label for="login-party-name" class="block text-sm font-medium text-gray-700">Party Name:</label>
                            <input type="text" id="login-party-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
                        </div>
                        <div>
                            <label for="login-party-password" class="block text-sm font-medium text-gray-700">Password:</label>
                            <input type="password" id="login-party-password" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
                        </div>
                        <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 rounded-lg shadow-md">Login</button>
                    </form>
                </div>

                <div id="candidate-dashboard" class="mt-6 p-4 border border-gray-200 rounded-md bg-gray-50">
                    <!-- Candidate dashboard content will be loaded here -->
                    <button id="logout-candidate-btn" class="mt-4 bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 rounded-lg shadow-md">Logout</button>
                </div>

                <h3 class="text-xl font-medium mt-6 mb-4">Register New Candidate</h3>
                <form id="register-candidate-form" class="space-y-4">
                    <div>
                        <label for="candidate-name" class="block text-sm font-medium text-gray-700">Candidate Name:</label>
                        <input type="text" id="candidate-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="party-name-reg" class="block text-sm font-medium text-gray-700">Party Name:</label>
                        <input type="text" id="party-name-reg" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="party-password-reg" class="block text-sm font-medium text-gray-700">Party Password:</label>
                        <input type="password" id="party-password-reg" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="party-chinn" class="block text-sm font-medium text-gray-700">Party Symbol (Text/Emoji):</label>
                        <input type="text" id="party-chinn" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="party-logo-upload" class="block text-sm font-medium text-gray-700">Party Logo:</label>
                        <input type="file" id="party-logo-upload" accept="image/*" class="hidden">
                        <button type="button" id="upload-logo-btn" class="mt-1 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 rounded-lg shadow-md">Upload Logo</button>
                        <img id="logo-preview" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAQAAADa613fAAAAaElEQVR42u3PQREAAAgDoC2G/Yt62e20IIDz9wYBAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgMDbA3cAAR2gLdJPAAAAAElFTkSuQmCC" alt="Logo Preview" class="mt-2 w-24 h-24 object-cover rounded-md border border-gray-300">
                    </div>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 rounded-lg shadow-md">Register Party</button>
                </form>
            </div>
        </section>
    </div>

    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="custom-alert-modal">
        <div class="custom-alert-content">
            <p id="alert-message" class="text-lg font-semibold mb-4"></p>
            <button id="alert-ok-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 rounded-lg shadow-md">OK</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => { // Marked as async
            // --- DOM Elements ---
            const initialLoginSection = document.getElementById('initial-login-section');
            const votingIdInput = document.getElementById('voting-id-input');
            const votingIdLoginBtn = document.getElementById('voting-id-login-btn');
            const mainAppContainer = document.getElementById('main-app-container');
            const container = document.querySelector('.container');

            const editionSelect = document.getElementById('edition');
            const bedrockNameField = document.getElementById('bedrock-name-field');
            const javaNameField = document.getElementById('java-name-field');
            const voteSection = document.getElementById('vote-section');
            const playerDetailsFormContainer = document.getElementById('player-details-form-container');
            const playerDetailsForm = document.getElementById('player-details-form');
            const playerDetailsDisplay = document.getElementById('player-details-display');
            const partyListForVoting = document.getElementById('party-list-for-voting');
            const registerCandidateForm = document.getElementById('register-candidate-form');
            const liveVoteCountDiv = document.getElementById('live-vote-count');
            const partyListDiv = document.getElementById('party-list');
            const nextBtn = document.getElementById('next-btn');
            const changePlayerDetailsBtn = document.getElementById('change-player-details-btn');
            const candidateManagementSection = document.getElementById('candidate-management-section');
            const candidateDashboard = document.getElementById('candidate-dashboard');
            const logoPreview = document.getElementById('logo-preview');
            const uploadLogoBtn = document.getElementById('upload-logo-btn');
            const partyLogoUpload = document.getElementById('party-logo-upload');
            const partyManagementLoginSection = document.getElementById('party-management-login-section');
            const partyLoginForm = document.getElementById('party-login-form');
            const logoutCandidateBtn = document.getElementById('logout-candidate-btn');

            // Custom Alert Modal Elements
            const customAlertModal = document.getElementById('custom-alert-modal');
            const alertMessage = document.getElementById('alert-message');
            const alertOkBtn = document.getElementById('alert-ok-btn');

            // --- Constants & State Variables ---
            // IMPORTANT: Replace this with your actual deployed Cloudflare Worker URL
            const API_BASE_URL = 'YOUR_CLOUDFLARE_WORKER_URL/api';
            const placeholderImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAQAAADa613fAAAAaElEQVR42u3PQREAAAgDoC2G/Yt62e20IIDz9wYBAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgAABAgQIECBAgMDbA3cAAR2gLdJPAAAAAElFTkSuQmCC';
            const MAX_IMAGE_SIZE_MB = 5;

            let candidates = []; // Will be fetched from API
            let votes = []; // Will be fetched from API
            let validVotingIds = []; // Fetched from API
            let usedVotingIds = []; // Fetched from API
            let currentVotingId = sessionStorage.getItem('currentVotingId') || null; // Persist validated voting ID
            let playerData = JSON.parse(sessionStorage.getItem('playerData')) || null;
            let loggedInCandidate = JSON.parse(sessionStorage.getItem('loggedInCandidate')) || null;

            // --- API Fetch Functions ---

            /**
             * Generic async function to fetch data from the API.
             * @param {string} endpoint - The API endpoint (e.g., '/candidates').
             * @returns {Promise<Array|Object|null>} - Parsed JSON data or null on error.
             */
            async function fetchData(endpoint) {
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`API Error fetching ${endpoint}: ${response.status} - ${errorText}`);
                        showCustomAlert(`Error loading data: ${response.statusText}`);
                        return null;
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Network error fetching ${endpoint}:`, error);
                    showCustomAlert(`Network error: Could not connect to server.`);
                    return null;
                }
            }

            /**
             * Generic async function to post data to the API.
             * @param {string} endpoint - The API endpoint (e.g., '/register-candidate').
             * @param {Object} data - The data to send in the request body.
             * @returns {Promise<Object|null>} - Parsed JSON response or null on error.
             */
            async function postData(endpoint, data) {
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`API Error posting to ${endpoint}: ${response.status} - ${errorText}`);
                        showCustomAlert(`Error: ${errorText || response.statusText}`);
                        return null;
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Network error posting to ${endpoint}:`, error);
                    showCustomAlert(`Network error: Could not connect to server.`);
                    return null;
                }
            }

            // --- Helper Functions ---

            /**
             * Displays a custom alert modal with a given message.
             * @param {string} message - The message to display in the alert.
             */
            function showCustomAlert(message) {
                alertMessage.textContent = message;
                customAlertModal.classList.add('visible');
            }

            /**
             * Hides the custom alert modal.
             */
            function hideCustomAlert() {
                customAlertModal.classList.remove('visible');
            }

            /**
             * Toggles the display of Minecraft edition specific name fields.
             */
            function toggleEditionFields() {
                if (editionSelect.value === 'bedrock') {
                    bedrockNameField.style.display = 'block';
                    javaNameField.style.display = 'none';
                } else {
                    bedrockNameField.style.display = 'none';
                    javaNameField.style.display = 'block';
                }
            }

            /**
             * Updates and displays the live vote count for all parties.
             */
            async function updateLiveVoteCount() {
                votes = await fetchData('/votes');
                if (!votes) return; // Exit if data fetch failed

                liveVoteCountDiv.innerHTML = '';
                const voteCounts = {};

                votes.forEach(vote => {
                    voteCounts[vote.party] = (voteCounts[vote.party] || 0) + 1;
                });

                const sortedVoteCounts = Object.entries(voteCounts).sort(([, countA], [, countB]) => countB - countA);

                if (sortedVoteCounts.length > 0) {
                    sortedVoteCounts.forEach(([party, count]) => {
                        const partyData = candidates.find(c => c.partyName === party);
                        const div = document.createElement('div');
                        div.classList.add('vote-count-item', 'flex', 'items-center', 'p-2', 'bg-gray-50', 'rounded-md', 'shadow-sm');

                        if (partyData && partyData.partyLogo) {
                            const logo = document.createElement('img');
                            logo.src = partyData.partyLogo;
                            logo.alt = partyData.partyName;
                            logo.classList.add('party-logo-small');
                            div.appendChild(logo);
                        }

                        const text = document.createElement('span');
                        text.textContent = `${party}: ${count} votes`;
                        div.appendChild(text);

                        liveVoteCountDiv.appendChild(div);
                    });
                } else {
                    liveVoteCountDiv.textContent = 'No votes cast yet.';
                    liveVoteCountDiv.classList.add('text-center', 'text-gray-500');
                }
            }

            /**
             * Displays the list of registered parties for voting.
             */
            async function displayPartyList() {
                candidates = await fetchData('/candidates');
                if (!candidates) return; // Exit if data fetch failed

                partyListDiv.innerHTML = '';
                if (candidates.length === 0) {
                    partyListDiv.textContent = 'No parties registered yet. Be the first to register!';
                    partyListDiv.classList.add('text-center', 'text-gray-500');
                    return;
                }

                candidates.forEach(candidate => {
                    const partyCard = document.createElement('div');
                    partyCard.classList.add('party-card', 'bg-white', 'p-4', 'rounded-lg', 'shadow-md', 'flex', 'flex-col', 'items-center', 'text-center', 'border', 'border-gray-200');

                    const partyLogo = document.createElement('img');
                    partyLogo.src = candidate.partyLogo || placeholderImage;
                    partyLogo.alt = candidate.partyName;
                    partyLogo.classList.add('w-24', 'h-24', 'object-cover', 'rounded-full', 'mb-4', 'border', 'border-gray-300');

                    const partyName = document.createElement('h3');
                    partyName.textContent = candidate.partyName;
                    partyName.classList.add('text-xl', 'font-semibold', 'mb-2', 'text-gray-800');

                    const partyLeader = document.createElement('p');
                    partyLeader.textContent = `Leader: ${candidate.candidateName}`;
                    partyLeader.classList.add('text-gray-600', 'text-sm');

                    const partyChinn = document.createElement('p');
                    partyChinn.textContent = `Symbol: ${candidate.partyChinn}`;
                    partyChinn.classList.add('text-gray-600', 'text-sm', 'mb-4');

                    const voteButton = document.createElement('button');
                    voteButton.textContent = 'Vote for this Party';
                    voteButton.classList.add('bg-blue-500', 'hover:bg-blue-700', 'text-white', 'font-bold', 'py-2', 'px-4', 'rounded-md', 'transition', 'duration-300', 'rounded-lg', 'shadow-md');
                    voteButton.addEventListener('click', async () => {
                        if (!currentVotingId) {
                            showCustomAlert('Please log in with your Voting ID first.');
                            return;
                        }
                        if (!playerData) {
                            showCustomAlert('Please enter your player details first in the "Vote" section.');
                            activateSection(voteSection);
                            playerDetailsFormContainer.style.display = 'block';
                            playerDetailsDisplay.style.display = 'none';
                            partyListForVoting.style.display = 'none';
                            return;
                        }

                        const voteData = {
                            ...playerData,
                            party: candidate.partyName,
                            votingId: currentVotingId // Include the validated voting ID
                        };

                        const result = await postData('/submit-vote', voteData);
                        if (result && result.success) {
                            showCustomAlert(`You have successfully voted for ${candidate.partyName}!`);
                            await updateLiveVoteCount(); // Refresh vote count
                            // After voting, clear player data for a new vote if desired, or keep it
                            // playerData = null;
                            // sessionStorage.removeItem('playerData');
                            // updateVoteSectionDisplay();
                        } else {
                            showCustomAlert(result ? result.message : 'Failed to submit vote.');
                        }
                    });

                    partyCard.appendChild(partyLogo);
                    partyCard.appendChild(partyName);
                    partyCard.appendChild(partyLeader);
                    partyCard.appendChild(partyChinn);
                    partyCard.appendChild(voteButton);
                    partyListDiv.appendChild(partyCard);
                });
            }

            /**
             * Gets the total votes for a specific party.
             * @param {string} partyName - The name of the party.
             * @returns {number} The total number of votes for the party.
             */
            function getPartyVoteCount(partyName) {
                return votes.filter(vote => vote.party === partyName).length;
            }

            /**
             * Handles candidate login.
             * @param {string} partyName - The party name to log in with.
             * @param {string} password - The password to log in with.
             */
            async function loginCandidate(partyName, password) {
                candidates = await fetchData('/candidates'); // Ensure latest candidates are loaded
                if (!candidates) return;

                // IMPORTANT: btoa() is NOT encryption. This is for demonstration only.
                // In a real application, passwords should be securely hashed and compared server-side.
                loggedInCandidate = candidates.find(c => c.partyName === partyName && c.password === btoa(password));

                if (loggedInCandidate) {
                    sessionStorage.setItem('loggedInCandidate', JSON.stringify(loggedInCandidate));
                    showCustomAlert('Login successful! Welcome to your dashboard.');
                    activateSection(candidateManagementSection);
                } else {
                    showCustomAlert('Invalid Party Name or Password.');
                    loggedInCandidate = null;
                    sessionStorage.removeItem('loggedInCandidate');
                    displayCandidateDashboard(); // This will hide the dashboard if login failed
                }
            }

            /**
             * Handles candidate logout.
             */
            function logoutCandidate() {
                loggedInCandidate = null;
                sessionStorage.removeItem('loggedInCandidate');
                displayCandidateDashboard(); // This will hide the dashboard
                showCustomAlert('Logged out successfully.');
                activateSection(partyManagementLoginSection); // Go back to login section
            }

            /**
             * Displays the candidate's dashboard if logged in.
             */
            async function displayCandidateDashboard() {
                if (loggedInCandidate) {
                    candidateManagementSection.style.display = 'block';
                    partyManagementLoginSection.style.display = 'none'; // Hide login form
                    candidateDashboard.style.display = 'block'; // Show dashboard content
                    await updateLiveVoteCount(); // Ensure vote count is fresh for dashboard
                    candidateDashboard.innerHTML = `
                        <h3 class="text-xl font-medium mb-2">Welcome, ${loggedInCandidate.candidateName}!</h3>
                        <p class="text-gray-700">Party: ${loggedInCandidate.partyName}</p>
                        <p class="text-gray-700 mb-4">Symbol: ${loggedInCandidate.partyChinn}</p>
                        <img src="${loggedInCandidate.partyLogo}" alt="${loggedInCandidate.partyName}" class="party-logo-large mb-4">
                        <p class="text-lg font-bold text-gray-800">Your party currently has <strong>${getPartyVoteCount(loggedInCandidate.partyName)}</strong> votes.</p>
                        <button id="logout-candidate-btn" class="mt-4 bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 rounded-lg shadow-md">Logout</button>
                    `;
                    // Re-attach event listener for logout button as it's re-rendered
                    document.getElementById('logout-candidate-btn').addEventListener('click', logoutCandidate);
                } else {
                    candidateManagementSection.style.display = 'block'; // Keep section visible but show login
                    partyManagementLoginSection.style.display = 'block'; // Show login form
                    candidateDashboard.style.display = 'none'; // Hide dashboard content
                }
            }

            /**
             * Manages the display of the vote section based on whether player data is entered.
             */
            function updateVoteSectionDisplay() {
                if (playerData) {
                    playerDetailsFormContainer.style.display = 'none';
                    playerDetailsDisplay.style.display = 'block';
                    partyListForVoting.style.display = 'block';
                    document.getElementById('display-minecraft-name').textContent = playerData.minecraftName;
                    document.getElementById('display-edition').textContent = playerData.edition;
                    document.getElementById('display-real-name').textContent = playerData.realName || 'N/A';
                    document.getElementById('display-discord-insta').textContent = playerData.discordInsta || 'N/A';
                    displayPartyList(); // Refresh party list for voting
                } else {
                    playerDetailsFormContainer.style.display = 'block';
                    playerDetailsDisplay.style.display = 'none';
                    partyListForVoting.style.display = 'none';
                    playerDetailsForm.reset();
                }
            }

            /**
             * Activates a specific section, expanding it and moving others to the sidebar.
             * @param {HTMLElement} sectionToActivate - The section element to expand.
             */
            function activateSection(sectionToActivate) {
                const allSections = document.querySelectorAll('.container > section');

                // If the clicked section is already active, collapse it and revert to default layout
                if (sectionToActivate.classList.contains('active')) {
                    allSections.forEach(section => {
                        section.classList.remove('active', 'expanded-main-section', 'sidebar-section');
                        section.querySelector('.section-content').classList.add('collapsed');
                    });
                    container.classList.remove('two-column-active');
                } else {
                    // Otherwise, activate the clicked section and set up two-column layout
                    allSections.forEach(section => {
                        section.classList.remove('active', 'expanded-main-section', 'sidebar-section');
                        section.querySelector('.section-content').classList.add('collapsed');
                    });

                    sectionToActivate.classList.add('active', 'expanded-main-section');
                    sectionToActivate.querySelector('.section-content').classList.remove('collapsed');

                    allSections.forEach(section => {
                        if (section !== sectionToActivate) {
                            section.classList.add('sidebar-section');
                        }
                    });

                    container.classList.add('two-column-active');

                    if (sectionToActivate.id === 'vote-section') {
                        updateVoteSectionDisplay();
                    }
                    if (sectionToActivate.id === 'live-vote-section') {
                        updateLiveVoteCount();
                    }
                    if (sectionToActivate.id === 'candidate-management-section') {
                        displayCandidateDashboard();
                    }
                }
            }

            // --- Event Listeners ---

            // Custom Alert OK button
            alertOkBtn.addEventListener('click', hideCustomAlert);

            // Initial Voting ID Login
            votingIdLoginBtn.addEventListener('click', async () => {
                const id = votingIdInput.value.trim();
                if (!id) {
                    showCustomAlert('Please enter your Voting ID.');
                    return;
                }

                const result = await postData('/check-voting-id', { votingId: id });

                if (result && result.success && result.valid && !result.used) {
                    currentVotingId = id;
                    sessionStorage.setItem('currentVotingId', currentVotingId);
                    initialLoginSection.style.display = 'none';
                    mainAppContainer.style.display = 'flex'; // Use flex for the main container
                    showCustomAlert('Login successful! Welcome.');
                    // Initialize main app content after successful login
                    await Promise.all([updateLiveVoteCount(), displayPartyList()]); // Fetch initial data
                    activateSection(voteSection); // Activate vote section by default
                } else {
                    showCustomAlert(result ? result.message : 'Invalid or already used Voting ID.');
                }
            });

            // Section Header Toggles
            const sectionHeaders = document.querySelectorAll('.section-header');
            sectionHeaders.forEach(header => {
                header.addEventListener('click', (e) => {
                    const currentSection = e.currentTarget.parentElement;
                    activateSection(currentSection);
                });
            });

            // Minecraft Edition Select Change
            editionSelect.addEventListener('change', toggleEditionFields);

            // Player Details Form Submission (Next Button)
            nextBtn.addEventListener('click', () => {
                const edition = editionSelect.value;
                let minecraftNameInput;
                if (edition === 'bedrock') {
                    minecraftNameInput = document.getElementById('bedrock-name');
                } else {
                    minecraftNameInput = document.getElementById('java-name');
                }

                if (!minecraftNameInput.value.trim()) {
                    showCustomAlert('Please enter your Minecraft Name.');
                    minecraftNameInput.focus();
                    return;
                }

                playerData = {
                    edition,
                    minecraftName: minecraftNameInput.value,
                    realName: document.getElementById('real-name').value,
                    discordInsta: document.getElementById('discord-insta').value
                };
                sessionStorage.setItem('playerData', JSON.stringify(playerData));

                updateVoteSectionDisplay();
            });

            // Change Player Details Button
            changePlayerDetailsBtn.addEventListener('click', () => {
                playerData = null;
                sessionStorage.removeItem('playerData');
                updateVoteSectionDisplay();
            });

            // Party Logo Upload
            uploadLogoBtn.addEventListener('click', () => {
                partyLogoUpload.click();
            });

            partyLogoUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > MAX_IMAGE_SIZE_MB * 1024 * 1024) {
                        showCustomAlert(`Image size should be less than ${MAX_IMAGE_SIZE_MB}MB.`);
                        // Clear the file input to prevent re-uploading too large file
                        event.target.value = '';
                        logoPreview.src = placeholderImage; // Reset preview
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        logoPreview.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Register Candidate Form Submission
            registerCandidateForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const candidateName = document.getElementById('candidate-name').value;
                const partyName = document.getElementById('party-name-reg').value;
                const partyPassword = document.getElementById('party-password-reg').value;
                const partyChinn = document.getElementById('party-chinn').value;
                const partyLogo = logoPreview.src;

                // Basic client-side check for duplicate party name (server will also validate)
                if (candidates.some(c => c.partyName.toLowerCase() === partyName.toLowerCase())) {
                    showCustomAlert('A party with this name already exists. Please choose a different party name.');
                    return;
                }

                const newCandidate = {
                    candidateName,
                    partyName,
                    // IMPORTANT: btoa() is NOT encryption. This is for demonstration only.
                    // In a real application, passwords should be securely hashed and compared server-side.
                    password: btoa(partyPassword),
                    partyChinn,
                    partyLogo
                };

                const result = await postData('/register-candidate', newCandidate);

                if (result && result.success) {
                    showCustomAlert('Candidate registered successfully!');
                    registerCandidateForm.reset();
                    logoPreview.src = placeholderImage;
                    loginCandidate(partyName, partyPassword); // Automatically log in
                    await Promise.all([updateLiveVoteCount(), displayPartyList()]); // Refresh data
                } else {
                    showCustomAlert(result ? result.message : 'Failed to register candidate.');
                }
            });

            // Party Login Form Submission
            partyLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const loginPartyName = document.getElementById('login-party-name').value;
                const loginPartyPassword = document.getElementById('login-party-password').value;
                loginCandidate(loginPartyName, loginPartyPassword);
                partyLoginForm.reset();
            });

            // Candidate Logout Button (initial attachment, will be re-attached if dashboard re-renders)
            logoutCandidateBtn.addEventListener('click', logoutCandidate);

            // --- Initial Setup on Load ---
            toggleEditionFields();

            // Check if user is already logged in with a voting ID
            if (currentVotingId) {
                initialLoginSection.style.display = 'none';
                mainAppContainer.style.display = 'flex'; // Use flex for the main container
                // Re-fetch all data and set up UI
                await Promise.all([updateLiveVoteCount(), displayPartyList(), displayCandidateDashboard()]);
                activateSection(voteSection); // Activate vote section by default
            } else {
                initialLoginSection.style.display = 'flex'; // Show login screen
                mainAppContainer.style.display = 'none'; // Hide main app
            }
        });
    </script>
</body>
</html>
`;

/**
 * Fetches file content from GitHub.
 * @param {string} filePath - The path to the file in the repository.
 * @param {string} token - GitHub Personal Access Token.
 * @returns {Promise<{content: any, sha: string}|null>} - File content (parsed JSON) and its SHA, or null on error.
 */
async function fetchGitHubFile(filePath, token) {
    const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}?ref=${BRANCH}`;
    try {
        const response = await fetch(url, {
            headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });

        if (response.status === 404) {
            console.warn(`File not found on GitHub: ${filePath}. Returning empty content.`);
            // For new files, return an empty array and null SHA so it can be created
            return { content: [], sha: null };
        }

        if (!response.ok) {
            const errorText = await response.text();
            console.error(`GitHub API Error fetching ${filePath}: ${response.status} - ${errorText}`);
            throw new Error(`Failed to fetch file from GitHub: ${response.statusText}`);
        }

        const data = await response.json();
        const content = JSON.parse(atob(data.content)); // Decode base64 content
        return { content, sha: data.sha };
    } catch (error) {
        console.error(`Network or parsing error fetching ${filePath}:`, error);
        return null;
    }
}

/**
 * Updates file content on GitHub.
 * @param {string} filePath - The path to the file in the repository.
 * @param {any} newContent - The new content to write (will be stringified).
 * @param {string|null} sha - The SHA of the file's current version for optimistic concurrency.
 * Pass null for creating a new file.
 * @param {string} token - GitHub Personal Access Token.
 * @param {string} commitMessage - The commit message.
 * @returns {Promise<boolean>} - True if successful, false otherwise.
 */
async function updateGitHubFile(filePath, newContent, sha, token, commitMessage) {
    const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}`;
    const contentBase64 = btoa(JSON.stringify(newContent, null, 2)); // Encode new content to base64

    const body = {
        message: commitMessage,
        content: contentBase64,
        branch: BRANCH
    };

    // SHA is required for updating existing files, but not for creating new ones.
    if (sha) {
        body.sha = sha;
    }

    try {
        const response = await fetch(url, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
        });

        if (!response.ok) {
            const errorData = await response.json();
            if (response.status === 409 && errorData.message.includes('sha mismatch')) {
                // Explicitly throw an error for SHA mismatch to trigger retry logic
                throw new Error('sha mismatch: File has been updated by another process.');
            }
            console.error(`GitHub API Error updating ${filePath}: ${response.status} - ${JSON.stringify(errorData)}`);
            return false;
        }

        return true;
    } catch (error) {
        console.error(`Network or API error updating ${filePath}:`, error);
        throw error; // Re-throw to be caught by retry logic in handleRequest
    }
}

// Main Cloudflare Worker Event Listener
// The 'env' object is how Cloudflare Workers expose environment variables/secrets.
// Ensure GITHUB_TOKEN_VAR is set as a secret in your Cloudflare Worker settings.
addEventListener('fetch', event => {
    event.respondWith(handleRequest(event.request, event.env));
});

async function handleRequest(request, env) {
    const url = new URL(request.url);
    const path = url.pathname;

    // Retrieve GitHub token from environment variables
    // IMPORTANT: Make sure you have added GITHUB_TOKEN_VAR as a secret in your Cloudflare Worker settings.
    const GITHUB_TOKEN = env.GITHUB_TOKEN_VAR;

    if (!GITHUB_TOKEN) {
        return new Response('GitHub token is not configured in Cloudflare Worker secrets.', { status: 500 });
    }

    // Handle API requests (only paths starting with /api/)
    if (path.startsWith('/api/')) {
        const apiPath = path.substring(5); // Remove '/api/' prefix

        try {
            switch (apiPath) {
                case 'candidates':
                    if (request.method === 'GET') {
                        const { content } = await fetchGitHubFile(CANDIDATES_PATH, GITHUB_TOKEN) || { content: [] };
                        return new Response(JSON.stringify(content), { headers: { 'Content-Type': 'application/json' } });
                    }
                    break;

                case 'votes':
                    if (request.method === 'GET') {
                        const { content } = await fetchGitHubFile(VOTES_PATH, GITHUB_TOKEN) || { content: [] };
                        return new Response(JSON.stringify(content), { headers: { 'Content-Type': 'application/json' } });
                    }
                    break;

                case 'voting-ids':
                    if (request.method === 'GET') {
                        const { content } = await fetchGitHubFile(VOTING_IDS_PATH, GITHUB_TOKEN) || { content: [] };
                        return new Response(JSON.stringify(content), { headers: { 'Content-Type': 'application/json' } });
                    }
                    break;

                case 'used-voting-ids':
                    if (request.method === 'GET') {
                        const { content } = await fetchGitHubFile(USED_VOTING_IDS_PATH, GITHUB_TOKEN) || { content: [] };
                        return new Response(JSON.stringify(content), { headers: { 'Content-Type': 'application/json' } });
                    }
                    break;

                case 'check-voting-id':
                    if (request.method === 'POST') {
                        const { votingId } = await request.json();
                        if (!votingId) {
                            return new Response(JSON.stringify({ success: false, message: 'Voting ID is required.' }), { status: 400 });
                        }

                        const { content: validIds } = await fetchGitHubFile(VOTING_IDS_PATH, GITHUB_TOKEN) || { content: [] };
                        const { content: usedIds } = await fetchGitHubFile(USED_VOTING_IDS_PATH, GITHUB_TOKEN) || { content: [] };

                        const isValid = validIds.includes(votingId);
                        const isUsed = usedIds.includes(votingId);

                        if (!isValid) {
                            return new Response(JSON.stringify({ success: false, message: 'Invalid Voting ID.' }), { status: 401 });
                        }
                        if (isUsed) {
                            return new Response(JSON.stringify({ success: false, message: 'Voting ID has already been used.' }), { status: 403 });
                        }

                        return new Response(JSON.stringify({ success: true, valid: true, used: false, message: 'Voting ID accepted.' }), { headers: { 'Content-Type': 'application/json' } });
                    }
                    break;

                case 'register-candidate':
                    if (request.method === 'POST') {
                        const newCandidate = await request.json();
                        if (!newCandidate.partyName || !newCandidate.candidateName || !newCandidate.password) {
                            return new Response(JSON.stringify({ success: false, message: 'Missing required candidate fields.' }), { status: 400 });
                        }

                        // IMPORTANT: Passwords should be hashed and stored securely, not base64 encoded.
                        // This implementation is for demonstration purposes only.

                        const MAX_RETRIES = 3;
                        for (let i = 0; i < MAX_RETRIES; i++) {
                            try {
                                let candidatesData = await fetchGitHubFile(CANDIDATES_PATH, GITHUB_TOKEN);
                                let candidates = candidatesData ? candidatesData.content : [];
                                let sha = candidatesData ? candidatesData.sha : null;

                                // Server-side check for duplicate party name
                                if (candidates.some(c => c.partyName.toLowerCase() === newCandidate.partyName.toLowerCase())) {
                                    return new Response(JSON.stringify({ success: false, message: 'A party with this name already exists.' }), { status: 409 });
                                }

                                candidates.push(newCandidate);

                                const success = await updateGitHubFile(CANDIDATES_PATH, candidates, sha, GITHUB_TOKEN, `Add new candidate: ${newCandidate.candidateName}`);
                                if (success) {
                                    return new Response(JSON.stringify({ success: true, message: 'Candidate registered successfully.' }), { headers: { 'Content-Type': 'application/json' } });
                                }
                            } catch (e) {
                                console.warn(`Retry ${i + 1} for updating candidates.json:`, e.message);
                                if (e.message.includes('sha mismatch')) {
                                    // This retry will automatically refetch the latest file in the next iteration
                                    // and re-attempt the update.
                                    continue; // Continue to the next retry attempt
                                } else {
                                    throw e; // Re-throw other errors
                                }
                            }
                        }
                        return new Response(JSON.stringify({ success: false, message: 'Failed to register candidate after multiple retries due to concurrent updates.' }), { status: 500 });
                    }
                    break;

                case 'submit-vote':
                    if (request.method === 'POST') {
                        const voteData = await request.json();
                        const { votingId, party } = voteData;

                        if (!votingId || !party) {
                            return new Response(JSON.stringify({ success: false, message: 'Missing voting ID or party for vote submission.' }), { status: 400 });
                        }

                        const MAX_RETRIES = 3;
                        for (let i = 0; i < MAX_RETRIES; i++) {
                            try {
                                // Re-validate voting ID and check if used (important for server-side)
                                const { content: validIds } = await fetchGitHubFile(VOTING_IDS_PATH, GITHUB_TOKEN) || { content: [] };
                                if (!validIds.includes(votingId)) {
                                    return new Response(JSON.stringify({ success: false, message: 'Invalid Voting ID provided for vote submission.' }), { status: 401 });
                                }

                                let usedIdsData = await fetchGitHubFile(USED_VOTING_IDS_PATH, GITHUB_TOKEN);
                                let usedIds = usedIdsData ? usedIdsData.content : [];
                                let usedIdsSha = usedIdsData ? usedIdsData.sha : null;

                                if (usedIds.includes(votingId)) {
                                    return new Response(JSON.stringify({ success: true, message: 'This Voting ID has already been used to vote.' }), { headers: { 'Content-Type': 'application/json' } });
                                }

                                let votesFile = await fetchGitHubFile(VOTES_PATH, GITHUB_TOKEN);
                                let currentVotes = votesFile ? votesFile.content : [];
                                let votesSha = votesFile ? votesFile.sha : null;

                                // Add vote and mark ID as used
                                currentVotes.push(voteData);
                                usedIds.push(votingId);

                                // Try to update votes.json
                                const votesUpdated = await updateGitHubFile(VOTES_PATH, currentVotes, votesSha, GITHUB_TOKEN, `Add vote for ${party} by ${votingId}`);
                                if (!votesUpdated) throw new Error('Failed to update votes.json');

                                // Try to update used_voting_ids.json
                                const usedIdsUpdated = await updateGitHubFile(USED_VOTING_IDS_PATH, usedIds, usedIdsSha, GITHUB_TOKEN, `Mark voting ID ${votingId} as used`);
                                if (!usedIdsUpdated) throw new Error('Failed to update used_voting_ids.json');

                                return new Response(JSON.stringify({ success: true, message: 'Vote submitted successfully.' }), { headers: { 'Content-Type': 'application/json' } });

                            } catch (e) {
                                console.warn(`Retry ${i + 1} for vote submission:`, e.message);
                                if (e.message.includes('sha mismatch')) {
                                    // This retry will automatically refetch the latest files in the next iteration
                                    // and re-attempt the updates.
                                    continue; // Continue to the next retry attempt
                                } else {
                                    throw e; // Re-throw other errors
                                }
                            }
                        }
                        return new Response(JSON.stringify({ success: false, message: 'Failed to submit vote after multiple retries due to concurrent updates.' }), { status: 500 });
                    }
                    break;

                default:
                    return new Response('Not Found', { status: 404 });
            }
        } catch (error) {
            console.error('API Handler Error:', error);
            return new Response(JSON.stringify({ success: false, message: error.message || 'Internal Server Error' }), { status: 500 });
        }
    }

    // If the path is not an API endpoint, return a 404.
    // In a real setup, this might serve other static assets if you had them.
    return new Response('Not Found', { status: 404 });
}

